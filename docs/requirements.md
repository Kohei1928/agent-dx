# 要件定義書: TikTok人気動画収集ツール

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | TikTok Trend Collector |
| 作成日 | 2025年11月26日 |
| バージョン | 1.1 |

### 1.1 目的
TikTokの日本国内で人気の動画（再生回数・いいね数が高い動画）を自動収集し、Googleスプレッドシートに出力するツールを開発する。

### 1.2 背景
TikTokのトレンド動画を効率的に把握し、マーケティングやコンテンツ企画に活用するため。

### 1.3 利用者
- 個人利用（1ユーザー）

---

## 2. 機能要件

### 2.1 データ収集機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F-001 | トレンド動画取得 | 日本国内の人気動画をAPIから取得する |
| F-002 | フィルタリング | 再生回数・いいね数の最低ラインでフィルタリング |
| F-003 | ソート | 再生回数順 or いいね数順でソート可能 |
| F-004 | 取得件数制限 | 上位50件を取得 |

### 2.2 取得データ項目

| No | データ項目 | 必須 | 備考 |
|----|-----------|------|------|
| 1 | 動画タイトル（説明文） | ○ | TikTokは正式なタイトルがないため説明文を使用 |
| 2 | 動画URL | ○ | |
| 3 | 再生回数 | ○ | |
| 4 | いいね数 | ○ | |
| 5 | 投稿者名 | ○ | ユーザー名またはニックネーム |
| 6 | 投稿日 | ○ | |
| 7 | サムネイルURL | ○ | |
| 8 | 使用楽曲名 | ○ | 動画で使用されている楽曲情報 |

### 2.3 管理画面機能（WebUI）

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F-101 | ログイン | Google OAuthによる認証 |
| F-102 | ダッシュボード | 最新収集結果のサマリー表示 |
| F-103 | フィルタ設定 | 最低再生回数・いいね数の設定 |
| F-104 | ソート設定 | 再生回数順 or いいね数順の切り替え |
| F-105 | スプレッドシートID設定 | 出力先Googleスプレッドシートの設定 |
| F-106 | 実行時刻設定 | 定期実行の時刻設定 |
| F-107 | 手動実行 | ボタンクリックで即時データ収集を実行 |
| F-108 | 結果確認 | 最新の収集結果を画面上で確認 |
| F-109 | 実行履歴 | 過去の実行履歴（日時・件数・ステータス）を表示 |

### 2.4 出力機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F-201 | スプレッドシート出力 | Googleスプレッドシートにデータを出力 |
| F-202 | 日別シート作成 | 実行日ごとに新しいシートを追加（例: 2025-11-26） |
| F-203 | スプレッドシート新規作成 | 初回実行時にスプレッドシートを自動作成 |

### 2.5 自動実行機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F-301 | 定期実行 | 毎日自動でデータ収集を実行 |
| F-302 | 実行時刻設定 | 実行時刻を管理画面から設定可能（デフォルト: 毎日9:00 JST） |

### 2.6 通知機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F-401 | エラー通知（メール） | 定期実行失敗時にメールで通知 |
| F-402 | 通知先メールアドレス設定 | 管理画面から通知先を設定 |

---

## 3. 非機能要件

### 3.1 性能要件

| 項目 | 要件 |
|------|------|
| レスポンス時間 | 管理画面の表示: 3秒以内 |
| データ収集時間 | 1回の実行: 5分以内 |
| 同時アクセス | 1ユーザー（個人利用のため） |

### 3.2 可用性要件

| 項目 | 要件 |
|------|------|
| 稼働率 | 99%以上（GCP標準SLA） |
| 定期実行成功率 | 95%以上 |

### 3.3 データ保持要件

| 項目 | 要件 |
|------|------|
| データ保持期間 | 1年間 |
| 古いデータの処理 | 1年経過後に自動削除 |

### 3.4 セキュリティ要件

| 項目 | 要件 |
|------|------|
| 認証 | Google OAuth（Googleアカウントでログイン） |
| API Key管理 | 環境変数で管理（ソースコードに含めない） |
| 通信 | HTTPS必須 |

---

## 4. システム構成

### 4.1 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                         GCP Cloud                               │
│                                                                  │
│  ┌─────────────────┐    ┌─────────────────┐                     │
│  │   Cloud Run     │    │ Cloud Scheduler │                     │
│  │  (Next.js App)  │◄───│  (定期実行)      │                     │
│  └────────┬────────┘    └─────────────────┘                     │
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────┐                                            │
│  │  Cloud SQL      │                                            │
│  │  (PostgreSQL)   │                                            │
│  └─────────────────┘                                            │
│                                                                  │
└──────────┬──────────────────────────────────────────────────────┘
           │
           ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│  TikTok API      │  │ Google Sheets    │  │ SendGrid/Gmail   │
│  (RapidAPI経由)  │  │ API              │  │ (メール通知)      │
└──────────────────┘  └──────────────────┘  └──────────────────┘
```

### 4.2 技術スタック

| レイヤー | 技術 |
|----------|------|
| フロントエンド | Next.js 14 (App Router), React, Tailwind CSS |
| バックエンド | Next.js API Routes (Route Handlers) |
| ORM | Prisma |
| データベース | PostgreSQL (GCP Cloud SQL) |
| インフラ | GCP Cloud Run |
| 定期実行 | GCP Cloud Scheduler |
| データ取得 | RapidAPI (TikTok API) |
| データ出力 | Google Sheets API |
| 認証 | NextAuth.js (Google OAuth) |
| メール送信 | SendGrid または Gmail API |

---

## 5. 外部API

### 5.1 TikTok API（RapidAPI経由）

| 項目 | 内容 |
|------|------|
| 用途 | 日本のトレンド動画取得 |
| 料金 | Basic: 無料（500リクエスト/月）、Pro: $10/月〜 |
| 必要エンドポイント | トレンド動画一覧、動画詳細 |

### 5.2 Google Sheets API

| 項目 | 内容 |
|------|------|
| 用途 | 収集データの出力 |
| 料金 | 無料（GCP無料枠内） |
| 認証 | サービスアカウント |

### 5.3 メール送信API

| 項目 | 内容 |
|------|------|
| 用途 | エラー通知 |
| 候補 | SendGrid（無料枠: 100通/日）または Gmail API |

---

## 6. データベース設計

### 6.1 テーブル一覧

| テーブル名 | 説明 |
|-----------|------|
| users | ユーザー情報（認証用） |
| settings | アプリ設定（フィルタ条件、スプレッドシートID等） |
| videos | 収集した動画データ |
| execution_logs | 実行履歴 |

### 6.2 ER図（概要）

```
┌─────────────┐       ┌─────────────┐
│   users     │       │  settings   │
├─────────────┤       ├─────────────┤
│ id          │───────│ user_id     │
│ email       │       │ min_views   │
│ name        │       │ min_likes   │
│ created_at  │       │ sort_by     │
└─────────────┘       │ sheet_id    │
                      │ exec_time   │
                      │ notify_email│
                      └─────────────┘

┌─────────────────────┐       ┌─────────────────────┐
│      videos         │       │   execution_logs    │
├─────────────────────┤       ├─────────────────────┤
│ id                  │       │ id                  │
│ video_id (TikTok)   │       │ executed_at         │
│ title               │       │ status              │
│ url                 │       │ video_count         │
│ views               │       │ error_message       │
│ likes               │       │ created_at          │
│ author_name         │       └─────────────────────┘
│ posted_at           │
│ thumbnail_url       │
│ music_name          │
│ collected_at        │
│ created_at          │
└─────────────────────┘
```

### 6.3 データ保持ポリシー

- `videos` テーブル: 1年経過したレコードは自動削除
- `execution_logs` テーブル: 1年経過したレコードは自動削除
- 削除処理: 定期バッチで実行（週1回）

---

## 7. 画面設計（概要）

### 7.1 画面一覧

| 画面ID | 画面名 | 説明 |
|--------|--------|------|
| P-001 | ログイン画面 | Google OAuth認証 |
| P-002 | ダッシュボード | 最新収集結果のサマリー表示 |
| P-003 | 設定画面 | フィルタ条件・ソート順・実行時刻・スプレッドシートID・通知メールの設定 |
| P-004 | 結果一覧画面 | 収集した動画の一覧表示（サムネイル付き） |
| P-005 | 実行履歴画面 | 過去の実行履歴一覧 |

### 7.2 画面遷移図

```
[ログイン] → [ダッシュボード] ─┬─→ [設定画面]
                              ├─→ [結果一覧画面]
                              └─→ [実行履歴画面]
```

### 7.3 ダッシュボード画面イメージ

```
┌────────────────────────────────────────────────────────────┐
│  TikTok Trend Collector                    [設定] [ログアウト] │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  📊 最新の収集結果（2025-11-26）                            │
│  ┌──────────────────────────────────────────────────────┐ │
│  │ 取得件数: 50件  |  実行時刻: 09:00  |  ステータス: 成功  │ │
│  └──────────────────────────────────────────────────────┘ │
│                                                            │
│  [▶ 手動実行]                                              │
│                                                            │
│  📹 トップ動画プレビュー                                    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │ [thumb] │ │ [thumb] │ │ [thumb] │ │ [thumb] │          │
│  │ 150万再生│ │ 120万再生│ │ 100万再生│ │ 95万再生 │          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
│                                                            │
│  [結果一覧を見る]  [実行履歴を見る]                          │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## 8. データフロー

### 8.1 定期実行フロー

```
1. Cloud Scheduler が毎日指定時刻にAPIエンドポイントを呼び出し
   ↓
2. Next.js API Route が実行される
   ↓
3. RapidAPI経由でTikTokトレンド動画を取得
   ↓
4. フィルタリング（最低再生回数・いいね数）
   ↓
5. ソート（再生回数順 or いいね数順）
   ↓
6. 上位50件を抽出
   ↓
7. PostgreSQLにデータを保存
   ↓
8. Google Sheets APIで新しいシートを作成してデータ出力
   ↓
9. 実行履歴を保存
   ↓
10. エラー発生時はメール通知
```

---

## 9. 設定項目

### 9.1 フィルタ設定

| 設定項目 | データ型 | デフォルト値 | 説明 |
|----------|---------|-------------|------|
| 最低再生回数 | number | 100,000 | この値以上の動画のみ取得 |
| 最低いいね数 | number | 10,000 | この値以上の動画のみ取得 |

### 9.2 ソート設定

| 設定項目 | データ型 | デフォルト値 | 選択肢 |
|----------|---------|-------------|--------|
| ソート基準 | string | views | views（再生回数）/ likes（いいね数） |

### 9.3 出力設定

| 設定項目 | データ型 | デフォルト値 | 説明 |
|----------|---------|-------------|------|
| スプレッドシートID | string | (自動生成) | 出力先のGoogleスプレッドシートID |

### 9.4 実行設定

| 設定項目 | データ型 | デフォルト値 | 説明 |
|----------|---------|-------------|------|
| 実行時刻 | string | 09:00 | 毎日の自動実行時刻（JST） |
| 取得件数 | number | 50 | 1回の実行で取得する件数 |

### 9.5 通知設定

| 設定項目 | データ型 | デフォルト値 | 説明 |
|----------|---------|-------------|------|
| 通知先メールアドレス | string | (ログインユーザーのメール) | エラー通知の送信先 |

---

## 10. Googleスプレッドシート出力フォーマット

### 10.1 シート名
`YYYY-MM-DD`（例: 2025-11-26）

### 10.2 カラム構成

| 列 | ヘッダー名 | データ例 |
|----|-----------|----------|
| A | 順位 | 1 |
| B | 動画タイトル | 面白い動画です！ #おすすめ |
| C | 動画URL | https://www.tiktok.com/@user/video/xxx |
| D | 再生回数 | 1,500,000 |
| E | いいね数 | 150,000 |
| F | 投稿者名 | @username |
| G | 投稿日 | 2025-11-25 |
| H | サムネイルURL | https://p16-sign-sg.tiktokcdn.com/... |
| I | 使用楽曲 | オリジナル楽曲 - アーティスト名 |

---

## 11. API設計

### 11.1 エンドポイント一覧

| メソッド | エンドポイント | 説明 |
|----------|---------------|------|
| GET | /api/auth/[...nextauth] | 認証（NextAuth.js） |
| GET | /api/videos | 収集済み動画一覧取得 |
| GET | /api/videos/latest | 最新の収集結果取得 |
| POST | /api/collect | 手動でデータ収集を実行 |
| GET | /api/settings | 設定取得 |
| PUT | /api/settings | 設定更新 |
| GET | /api/logs | 実行履歴取得 |
| POST | /api/cron/collect | 定期実行用エンドポイント（Cloud Scheduler用） |

---

## 12. 開発スケジュール（目安）

| フェーズ | タスク | 期間 |
|----------|--------|------|
| Phase 1 | 環境構築・プロジェクト初期設定 | 1日 |
| Phase 2 | データベース設計・Prismaセットアップ | 1日 |
| Phase 3 | TikTok API連携実装 | 2-3日 |
| Phase 4 | Google Sheets連携実装 | 1-2日 |
| Phase 5 | 認証機能実装（NextAuth.js） | 1日 |
| Phase 6 | 管理画面UI実装 | 3-4日 |
| Phase 7 | メール通知機能実装 | 1日 |
| Phase 8 | 定期実行設定（Cloud Scheduler） | 1日 |
| Phase 9 | GCPデプロイ・テスト | 2-3日 |
| **合計** | | **約13-17日** |

---

## 13. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| TikTok APIの仕様変更 | 高 | 複数のAPIプロバイダーを調査しておく |
| RapidAPI利用料金の増加 | 中 | 月次でAPI利用量をモニタリング |
| レート制限 | 中 | リトライ処理・エラーハンドリングを実装 |
| 日本向けデータが取得できない | 中 | 複数のエンドポイントを試す |
| Cloud SQLのコスト | 中 | 最小インスタンスから開始、必要に応じてスケール |

---

## 14. GCPコスト見積もり（月額）

| サービス | 見積もり | 備考 |
|----------|---------|------|
| Cloud Run | $0〜5 | 無料枠内で収まる可能性あり |
| Cloud SQL (PostgreSQL) | $10〜20 | 最小インスタンス(db-f1-micro) |
| Cloud Scheduler | $0 | 無料枠内（3ジョブ/月） |
| RapidAPI | $10〜20 | Proプラン想定 |
| **合計** | **$20〜45/月** | |

---

## 15. 今後の拡張可能性（スコープ外）

- 重複排除オプション
- 動画プレビュー機能
- ステータス管理（確認済み、お気に入り等）
- メモ機能
- 検索・フィルタ機能
- CSVエクスポート
- Slack/Discord通知機能
- 複数国のトレンド対応
- ハッシュタグ別の収集
- データの可視化（グラフ表示）
- 統計ダッシュボード

---

## 16. 承認

| 役割 | 氏名 | 日付 | 署名 |
|------|------|------|------|
| 作成者 | | 2025/11/26 | |
| 承認者 | | | |

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|------------|------|----------|--------|
| 1.0 | 2025/11/26 | 初版作成 | |
| 1.1 | 2025/11/26 | 技術スタック更新（Prisma, PostgreSQL追加）、エラー通知・楽曲情報・スプレッドシートID設定機能追加、データ保持期間（1年）追加 | |
