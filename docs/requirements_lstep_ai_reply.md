# 要件定義書: Lステップ AI自動返信システム

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Lステップ AI自動返信システム |
| 作成日 | 2025年11月26日 |
| バージョン | 1.1 |

### 1.1 目的
Lステップで特定のタグがついたユーザーからのLINEメッセージに対して、AIが生成した適切な返信を30秒後に自動送信するシステムを構築する。

### 1.2 背景
- 顧客対応の効率化と応答速度の向上
- 人間らしい自然な返信タイミングによるユーザー体験の向上
- 定型的な問い合わせへの自動対応による運用負荷の軽減

### 1.3 利用者
- 管理者: 3名程度
- 対象ユーザー: Lステップで「AI自動返信」タグ等が付与されたLINEユーザー

---

## 2. 実現可能性の検証結果

### 2.1 調査結果サマリー

LステップのWebhook転送機能とAPIについて調査を実施した結果、以下の点が判明しました。

#### ✅ 確実に実現可能な部分

| 項目 | 状態 | 詳細 |
|------|------|------|
| Webhook受信 | ✅ 可能 | Lステップ Webhook転送機能（月額5,500円）で外部システムにメッセージを転送可能 |
| AI分類・生成 | ✅ 可能 | OpenAI GPT-4o で実現可能 |
| 遅延送信（30秒） | ✅ 可能 | GCP Cloud Tasks で実現可能 |
| 管理画面 | ✅ 可能 | Next.js + Tailwind CSS で実現可能 |

#### ⚠️ 確認が必要な部分

| 項目 | 状態 | 問題点 | 確認方法 |
|------|------|--------|----------|
| タグ情報の取得 | ⚠️ 要確認 | Webhook転送ではタグ情報が**送信されない** | Lステップサポートに問い合わせ |
| タグ条件フィルター | ⚠️ 不明確 | 「特定タグの人からのみ転送」設定の可否 | Lステップ管理画面で確認 |
| Lステップ API仕様 | ⚠️ 非公開 | 詳細なAPIドキュメントが公開されていない | LステップPlus⁺®の契約・問い合わせ |
| API利用料金 | ⚠️ 不明 | LステップPlus⁺®の追加費用 | Lステップに見積もり依頼 |

### 2.2 Webhook転送機能の制限事項

公式ドキュメントより確認された制限事項：

> 「API連携とは違い、Lステップから外部への一方向（LINE公式アカウント→Lステップ→外部）となり、**タグ情報などのLステップ特有のデータは送信されません**のでご注意くださいませ。」
> 
> 出典: https://linestep.jp/2025/06/13/lstep-webhook/

**送信されるデータ**: LINE公式アカウントのWebhookデータのみ
- ユーザーID
- メッセージ内容
- タイムスタンプ
- イベントタイプ（メッセージ、友だち追加など）

**送信されないデータ**:
- Lステップで付与したタグ情報
- ユーザーの友だち情報（Lステップ独自データ）
- カスタムフィールドの値

### 2.3 実現方式の選択肢

#### 方式A: Lステップ側でタグフィルターを設定（推奨）

```
【前提条件】
Lステップ側で「特定タグが付いたユーザーからのWebhookのみ転送する」設定が可能な場合

【フロー】
1. Lステップ管理画面でWebhook転送設定
   → 対象: 「AI自動返信」タグが付いたユーザーのみ
2. 外部システムはWebhookを受信した時点で対象ユーザーと判断
3. AI処理→30秒後にLステップ API経由で返信

【メリット】
- シンプルな実装
- 不要なWebhookを受信しない

【確認事項】
- Lステップでタグ条件によるWebhook転送フィルターが可能か
```

#### 方式B: Webhook受信後にLステップ APIでタグ情報を取得

```
【前提条件】
LステップのAPIでユーザーのタグ情報を取得できる場合

【フロー】
1. すべてのメッセージWebhookを受信
2. Lステップ APIでユーザーIDからタグ情報を取得
3. 対象タグが付いている場合のみ処理継続
4. AI処理→30秒後にLステップ API経由で返信

【メリット】
- 柔軟なタグ条件判定が可能
- 外部システム側で条件をコントロール可能

【デメリット】
- API呼び出し回数が増加（コスト増）
- LステップPlus⁺®の契約が必要な可能性

【確認事項】
- Lステップ APIでタグ情報取得エンドポイントがあるか
- API利用の料金体系
```

#### 方式C: LINE Messaging API を直接使用（代替案）

```
【前提条件】
Lステップ APIが利用できない、または高コストの場合

【フロー】
1. Lステップ Webhook転送でメッセージを受信
2. 全メッセージに対してAI処理
3. 30秒後にLINE Messaging API (Push Message) で返信

【メリット】
- Lステップ APIへの依存を回避
- LINE Messaging APIは仕様が公開されている

【デメリット】
- Lステップ上の会話履歴に返信が反映されない可能性
- タグ条件での絞り込みができない（全員に返信）
- LINE Messaging APIのPush Message数制限（料金プランによる）

【注意】
- 30秒後の返信には Push Message を使用（Reply Token は約1分で失効）
- Push Message はLINE公式アカウントの料金プランに依存
```

### 2.4 開発着手前に確認すべき事項

| # | 確認事項 | 確認先 | 重要度 |
|---|---------|--------|--------|
| 1 | Webhook転送でタグ条件フィルターが設定可能か | Lステップ管理画面 / サポート | 🔴 必須 |
| 2 | Lステップ APIでユーザーのタグ情報を取得できるか | Lステップサポート | 🔴 必須 |
| 3 | Lステップ APIでメッセージを送信できるか | Lステップサポート | 🔴 必須 |
| 4 | LステップPlus⁺®の利用料金 | Lステップ営業 | 🟡 重要 |
| 5 | API利用のレート制限（リクエスト数/分） | Lステップサポート | 🟡 重要 |
| 6 | Webhook転送の署名検証方法 | Lステップドキュメント | 🟢 推奨 |

### 2.5 推奨アクション

1. **Lステップサポートへの問い合わせ**
   - 上記確認事項1〜5について回答を得る
   - 可能であればAPI仕様書の提供を依頼

2. **PoCの実施**
   - Webhook転送の動作確認（テスト環境で実施）
   - 受信できるデータの内容を確認

3. **方式の確定**
   - 確認結果に基づき、方式A/B/Cのいずれかを選択
   - 本要件定義書を更新

---

## 3. システム構成

### 2.1 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            Google Cloud                                  │
│                                                                          │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐   │
│  │   Cloud Run     │     │  Cloud Tasks    │     │   Cloud SQL     │   │
│  │  (Next.js App)  │────▶│  (30秒遅延)     │     │  (PostgreSQL)   │   │
│  └────────┬────────┘     └────────┬────────┘     └─────────────────┘   │
│           │                       │                        ▲            │
│           │                       ▼                        │            │
│           │              ┌─────────────────┐               │            │
│           │              │   Reply Worker  │───────────────┘            │
│           │              │  (Cloud Run)    │                            │
│           │              └────────┬────────┘                            │
│           │                       │                                     │
└───────────┼───────────────────────┼─────────────────────────────────────┘
            │                       │
            ▼                       ▼
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│     Lステップ     │     │    Lステップ      │     │    OpenAI API    │
│  (Webhook転送)   │────▶│  (返信送信API)    │     │    (GPT-4o)      │
└──────────────────┘     └──────────────────┘     └──────────────────┘
         ▲                        ▲
         │                        │
┌────────┴────────────────────────┴────────┐
│              LINEユーザー                 │
│    (特定タグ付きユーザーからのメッセージ)    │
└──────────────────────────────────────────┘
```

### 2.2 技術スタック

| レイヤー | 技術 |
|----------|------|
| フロントエンド | Next.js 14 (App Router), React, Tailwind CSS |
| バックエンド | Next.js API Routes (Route Handlers) |
| ORM | Prisma |
| データベース | PostgreSQL (GCP Cloud SQL) |
| インフラ | GCP Cloud Run |
| 遅延実行 | GCP Cloud Tasks |
| AI | OpenAI GPT-4o / GPT-4o-mini |
| 外部連携 | Lステップ Webhook転送 / Lステップ API |
| 認証 | NextAuth.js (Google OAuth) |

---

## 4. ユースケース

### 3.1 ユースケース一覧

| UC-ID | ユースケース名 | アクター | 概要 |
|-------|---------------|---------|------|
| UC-001 | メッセージ受信・自動返信 | システム | 特定タグユーザーからのメッセージを受信し、30秒後にAI返信を送信 |
| UC-002 | 返信パターン登録 | 管理者 | 連絡タイプと返信テンプレートのペアを登録 |
| UC-003 | 返信パターン編集 | 管理者 | 既存の返信パターンを編集・削除 |
| UC-004 | タグ条件設定 | 管理者 | Webhook転送対象のタグ条件を設定 |
| UC-005 | メッセージ履歴確認 | 管理者 | 受信メッセージと返信履歴を確認 |
| UC-006 | 統計ダッシュボード表示 | 管理者 | メッセージ数・返信成功率等の統計を確認 |

### 3.2 ユースケース詳細

#### UC-001: メッセージ受信・自動返信

```
【概要】
特定タグが付いたユーザーからのLINEメッセージを受信し、
AIで分類・返信文を生成して30秒後に自動返信する

【事前条件】
- Lステップ側でWebhook転送設定が完了している
- 対象タグ条件が設定されている
- 返信パターンが1件以上登録されている

【基本フロー】
1. Lステップからメッセージ情報を含むWebhookを受信
2. メッセージ内容をDBに保存
3. AIでメッセージを分類（キーワード＋意図分類）
4. 該当する返信パターンを特定
5. AIで返信文を生成
6. Cloud Tasksに30秒後の返信タスクを登録
7. 30秒後、Lステップ APIで返信を送信
8. 返信結果をDBに保存

【代替フロー】
- 3a. 分類に失敗した場合 → 返信せず、ステータスを「未対応」として保存
- 5a. AI生成に失敗した場合 → 返信せず、ステータスを「生成エラー」として保存
- 7a. 送信に失敗した場合 → リトライ後、ステータスを「送信エラー」として保存

【事後条件】
- メッセージと返信がDBに記録される
- 成功時はユーザーに返信が届く
```

#### UC-002: 返信パターン登録

```
【概要】
管理者が連絡タイプと返信テンプレートのペアを新規登録する

【事前条件】
- 管理者がログイン済み

【基本フロー】
1. 管理者が返信パターン管理画面を開く
2. 「新規登録」ボタンをクリック
3. 以下の情報を入力:
   - パターン名
   - 連絡タイプ（カテゴリ）
   - 判定キーワード（任意）
   - AI分類用の説明文
   - 返信テンプレート（プロンプト）
   - 優先度
4. 「保存」ボタンをクリック
5. システムがバリデーション後、DBに保存
6. 完了メッセージを表示

【事後条件】
- 新しい返信パターンがDBに登録される
```

#### UC-003: 返信パターン編集

```
【概要】
管理者が既存の返信パターンを編集または削除する

【基本フロー（編集）】
1. 管理者が返信パターン一覧から対象を選択
2. 編集画面が開く
3. 内容を変更
4. 「保存」ボタンをクリック
5. 更新完了

【基本フロー（削除）】
1. 管理者が返信パターン一覧から対象を選択
2. 「削除」ボタンをクリック
3. 確認ダイアログを表示
4. 「確認」をクリック
5. 論理削除を実行
```

#### UC-004: タグ条件設定

```
【概要】
Webhook転送対象となるタグ条件（AND条件）を設定する

【基本フロー】
1. 管理者がタグ条件設定画面を開く
2. タグ条件グループを新規作成または編集
3. タグ名を追加（複数可、AND条件）
4. 有効/無効を設定
5. 保存

【備考】
- 実際のWebhook転送設定はLステップ管理画面で別途行う
- 本システムではどのタグ条件で受信したかを記録・管理する
```

#### UC-005: メッセージ履歴確認

```
【概要】
受信したメッセージと返信の履歴を確認する

【基本フロー】
1. 管理者が履歴画面を開く
2. 日付・ステータス等でフィルタリング（任意）
3. メッセージ一覧を確認
4. 詳細を見たい行をクリック
5. 受信メッセージ、分類結果、返信内容を確認
```

#### UC-006: 統計ダッシュボード表示

```
【概要】
システムの利用状況を統計情報で確認する

【表示項目】
- 今日/今週/今月のメッセージ受信数
- 返信成功率
- カテゴリ別メッセージ数
- 平均応答時間
- エラー発生数
```

---

## 5. 画面設計

### 4.1 画面一覧

| 画面ID | 画面名 | 説明 |
|--------|--------|------|
| P-001 | ログイン画面 | Google OAuth認証 |
| P-002 | ダッシュボード | 統計サマリー表示 |
| P-003 | 返信パターン一覧 | 登録済みパターンの一覧・検索 |
| P-004 | 返信パターン登録/編集 | パターンの新規登録・編集 |
| P-005 | タグ条件設定 | 対象タグ条件の管理 |
| P-006 | メッセージ履歴 | 受信メッセージ・返信の履歴一覧 |
| P-007 | メッセージ詳細 | 個別メッセージの詳細表示 |
| P-008 | システム設定 | API設定・一般設定 |

### 4.2 画面遷移図

```
[ログイン] → [ダッシュボード] ─┬─→ [返信パターン一覧] → [返信パターン登録/編集]
                              ├─→ [タグ条件設定]
                              ├─→ [メッセージ履歴] → [メッセージ詳細]
                              └─→ [システム設定]
```

### 4.3 画面イメージ

#### P-002: ダッシュボード

```
┌────────────────────────────────────────────────────────────────────┐
│  Lステップ AI自動返信           [返信パターン] [履歴] [設定] [ログアウト] │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  📊 本日の統計                           📅 2025年11月26日          │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐      │
│  │  受信数    │ │  返信成功   │ │  未対応    │ │  エラー    │      │
│  │   847     │ │   823      │ │    18     │ │     6     │      │
│  │  (+12%)   │ │  (97.2%)   │ │  (2.1%)   │ │  (0.7%)   │      │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘      │
│                                                                    │
│  📈 週間推移                                                        │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │    1000 ┤                                              ●     │ │
│  │     800 ┤                          ●      ●     ●            │ │
│  │     600 ┤        ●      ●                                    │ │
│  │     400 ┤   ●                                                │ │
│  │         └────┴────┴────┴────┴────┴────┴────                  │ │
│  │           月    火    水    木    金    土    日               │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  📋 カテゴリ別内訳（本日）                                          │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ 料金問い合わせ    ████████████████████████████ 312件 (36.8%)  │ │
│  │ 予約関連         ██████████████████████ 245件 (28.9%)        │ │
│  │ 商品について      ████████████████ 189件 (22.3%)              │ │
│  │ その他           ████████ 101件 (11.9%)                      │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  🕐 最近のメッセージ                                                │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ 14:32  料金問い合わせ   「料金を教えてください」    → 返信済み ✓  │ │
│  │ 14:31  予約関連        「明日の予約は...」        → 返信済み ✓  │ │
│  │ 14:28  商品について     「在庫はありますか」       → 返信済み ✓  │ │
│  │ 14:25  その他          「こんにちは」            → 未対応    │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                            [すべての履歴を見る →]  │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

#### P-003: 返信パターン一覧

```
┌────────────────────────────────────────────────────────────────────┐
│  返信パターン管理                                     [＋ 新規登録]  │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  🔍 検索: [________________________] [カテゴリ ▼] [ステータス ▼]   │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ # │ パターン名      │ カテゴリ      │ キーワード │優先度│状態 │ │
│  ├───┼────────────────┼──────────────┼───────────┼─────┼─────┤ │
│  │ 1 │ 料金案内        │ 料金問い合わせ │ 料金,価格  │  1  │ 有効│ │
│  │ 2 │ 予約確認        │ 予約関連      │ 予約,日程  │  2  │ 有効│ │
│  │ 3 │ 在庫確認        │ 商品について   │ 在庫,商品  │  3  │ 有効│ │
│  │ 4 │ 営業時間案内    │ 一般問い合わせ │ 営業,時間  │  4  │ 有効│ │
│  │ 5 │ キャンセル対応  │ 予約関連      │ キャンセル │  2  │ 有効│ │
│  │...│ ...            │ ...          │ ...       │ ... │ ... │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  ◀ 1 2 3 ... 10 ▶                        全30件中 1-10件を表示    │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

#### P-004: 返信パターン登録/編集

```
┌────────────────────────────────────────────────────────────────────┐
│  返信パターン登録                                    [← 一覧に戻る]  │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  基本情報                                                          │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ パターン名 *                                                   │ │
│  │ [料金案内_基本                                              ]  │ │
│  │                                                               │ │
│  │ カテゴリ *                          優先度                     │ │
│  │ [料金問い合わせ              ▼]     [1        ]               │ │
│  │                                                               │ │
│  │ ステータス                                                     │ │
│  │ ◉ 有効  ○ 無効                                               │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  分類条件                                                          │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ 判定キーワード（カンマ区切り）                                  │ │
│  │ [料金, 価格, いくら, 費用, 金額                             ]  │ │
│  │                                                               │ │
│  │ AI分類用の説明                                                 │ │
│  │ [サービスの料金や価格に関する問い合わせ。                      ]  │ │
│  │ [月額費用、初期費用、オプション料金などを聞いている場合。       ]  │ │
│  │ [                                                          ]  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  返信テンプレート（プロンプト）                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ あなたはカスタマーサポート担当です。                            │ │
│  │ 以下の料金情報を元に、丁寧でフレンドリーな返信を作成してください。│ │
│  │                                                               │ │
│  │ 【料金情報】                                                   │ │
│  │ ・基本プラン: 月額9,800円                                      │ │
│  │ ・スタンダードプラン: 月額19,800円                              │ │
│  │ ・プレミアムプラン: 月額29,800円                                │ │
│  │                                                               │ │
│  │ 【返信のトーン】                                               │ │
│  │ ・親しみやすく、でも丁寧に                                     │ │
│  │ ・絵文字は控えめに使用OK                                       │ │
│  │ ・100文字以内で簡潔に                                         │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  テスト                                                            │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ テスト入力: [料金を教えてください                           ]  │ │
│  │                                              [▶ テスト実行]   │ │
│  │                                                               │ │
│  │ 生成結果:                                                      │ │
│  │ ┌────────────────────────────────────────────────────────┐   │ │
│  │ │ お問い合わせありがとうございます😊                        │   │ │
│  │ │ 料金プランは以下の3つからお選びいただけます。             │   │ │
│  │ │ ・基本: 9,800円/月                                      │   │ │
│  │ │ ・スタンダード: 19,800円/月                              │   │ │
│  │ │ ・プレミアム: 29,800円/月                                │   │ │
│  │ │ ご不明点があればお気軽にどうぞ！                          │   │ │
│  │ └────────────────────────────────────────────────────────┘   │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│                                          [キャンセル]  [保存]      │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

#### P-005: タグ条件設定

```
┌────────────────────────────────────────────────────────────────────┐
│  タグ条件設定                                        [＋ 条件追加]  │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ⚠️ 注意: 実際のWebhook転送設定はLステップ管理画面で行ってください    │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ # │ 条件名        │ タグ（AND条件）              │ 状態      │ │
│  ├───┼──────────────┼────────────────────────────┼───────────┤ │
│  │ 1 │ 基本自動返信  │ AI自動返信                  │ ✓ 有効   │ │
│  │ 2 │ VIP対応      │ AI自動返信, VIP会員          │ ✓ 有効   │ │
│  │ 3 │ 新規見込み客  │ AI自動返信, 新規, 見込み客    │ ✓ 有効   │ │
│  │ 4 │ 既存顧客     │ AI自動返信, 契約中           │ ○ 無効   │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  ※ タグはすべてAND条件で判定されます                                │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

#### P-006: メッセージ履歴

```
┌────────────────────────────────────────────────────────────────────┐
│  メッセージ履歴                                                     │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  📅 期間: [2025/11/20] 〜 [2025/11/26]                             │
│  🔍 検索: [________________]  [カテゴリ ▼] [ステータス ▼] [検索]    │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ 日時        │ カテゴリ      │ 受信メッセージ   │ ステータス   │ │
│  ├────────────┼──────────────┼────────────────┼─────────────┤ │
│  │ 11/26 14:32│ 料金問い合わせ │ 料金を教えて... │ ✓ 返信済み  │ │
│  │ 11/26 14:31│ 予約関連      │ 明日の予約は... │ ✓ 返信済み  │ │
│  │ 11/26 14:28│ 商品について   │ 在庫はありま... │ ✓ 返信済み  │ │
│  │ 11/26 14:25│ (未分類)      │ こんにちは      │ ⚠️ 未対応   │ │
│  │ 11/26 14:20│ 予約関連      │ キャンセルし... │ ❌ エラー   │ │
│  │ ...        │ ...          │ ...            │ ...         │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  ◀ 1 2 3 ... 50 ▶                      全500件中 1-10件を表示     │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

#### P-007: メッセージ詳細

```
┌────────────────────────────────────────────────────────────────────┐
│  メッセージ詳細                                     [← 履歴に戻る]  │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  基本情報                                                          │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ 受信日時: 2025/11/26 14:32:15                                  │ │
│  │ 返信日時: 2025/11/26 14:32:45                                  │ │
│  │ ステータス: ✓ 返信済み                                         │ │
│  │ 分類カテゴリ: 料金問い合わせ                                    │ │
│  │ 使用パターン: 料金案内_基本                                     │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  受信メッセージ                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ 料金を教えてください。月額でいくらかかりますか？                  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  AI分類結果                                                        │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ カテゴリ: 料金問い合わせ (信頼度: 98.5%)                        │ │
│  │ マッチキーワード: 料金, 月額, いくら                            │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  送信した返信                                                       │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ お問い合わせありがとうございます😊                               │ │
│  │ 月額料金は以下の3プランからお選びいただけます。                   │ │
│  │ ・基本プラン: 9,800円/月                                       │ │
│  │ ・スタンダード: 19,800円/月                                    │ │
│  │ ・プレミアム: 29,800円/月                                      │ │
│  │ 詳しい資料もご用意できますので、お気軽にどうぞ！                  │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  処理ログ                                                          │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ 14:32:15.123 Webhook受信                                      │ │
│  │ 14:32:15.234 メッセージ保存完了                                │ │
│  │ 14:32:15.456 AI分類開始                                       │ │
│  │ 14:32:16.789 AI分類完了 (1.33s)                               │ │
│  │ 14:32:16.890 返信生成開始                                      │ │
│  │ 14:32:18.123 返信生成完了 (1.23s)                             │ │
│  │ 14:32:18.234 30秒タイマー設定                                  │ │
│  │ 14:32:45.001 返信送信実行                                      │ │
│  │ 14:32:45.567 返信送信完了                                      │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## 6. データ項目

### 5.1 テーブル一覧

| テーブル名 | 説明 |
|-----------|------|
| users | 管理者ユーザー情報 |
| tag_conditions | タグ条件設定 |
| tag_condition_tags | タグ条件に紐づくタグ名 |
| reply_patterns | 返信パターン定義 |
| messages | 受信メッセージ |
| replies | 送信した返信 |
| message_logs | メッセージ処理ログ |
| system_settings | システム設定 |

### 5.2 ER図

```
┌─────────────────┐
│     users       │
├─────────────────┤
│ id              │
│ email           │
│ name            │
│ role            │
│ created_at      │
│ updated_at      │
└─────────────────┘

┌─────────────────┐       ┌─────────────────────┐
│  tag_conditions │       │  tag_condition_tags │
├─────────────────┤       ├─────────────────────┤
│ id              │───┐   │ id                  │
│ name            │   └──▶│ tag_condition_id    │
│ is_active       │       │ tag_name            │
│ created_at      │       │ created_at          │
│ updated_at      │       └─────────────────────┘
└─────────────────┘

┌─────────────────────────┐
│     reply_patterns      │
├─────────────────────────┤
│ id                      │
│ name                    │
│ category                │
│ keywords                │ (JSON配列)
│ ai_description          │
│ prompt_template         │
│ priority                │
│ is_active               │
│ created_at              │
│ updated_at              │
│ deleted_at              │ (論理削除用)
└─────────────────────────┘

┌─────────────────────────┐       ┌─────────────────────────┐
│       messages          │       │        replies          │
├─────────────────────────┤       ├─────────────────────────┤
│ id                      │───┐   │ id                      │
│ line_user_id            │   └──▶│ message_id              │
│ message_content         │       │ reply_content           │
│ received_at             │       │ reply_pattern_id        │
│ tag_condition_id        │       │ sent_at                 │
│ category                │       │ status                  │
│ category_confidence     │       │ error_message           │
│ matched_keywords        │       │ created_at              │
│ status                  │       └─────────────────────────┘
│ created_at              │
│ updated_at              │
└─────────────────────────┘

┌─────────────────────────┐       ┌─────────────────────────┐
│     message_logs        │       │    system_settings      │
├─────────────────────────┤       ├─────────────────────────┤
│ id                      │       │ id                      │
│ message_id              │       │ key                     │
│ log_type                │       │ value                   │
│ log_message             │       │ description             │
│ metadata                │       │ updated_at              │
│ created_at              │       └─────────────────────────┘
└─────────────────────────┘
```

### 5.3 テーブル詳細

#### users（管理者ユーザー）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| email | VARCHAR(255) | NO | メールアドレス（ユニーク） |
| name | VARCHAR(100) | YES | 表示名 |
| role | ENUM | NO | 権限（admin, operator） |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

#### tag_conditions（タグ条件）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| name | VARCHAR(100) | NO | 条件名 |
| is_active | BOOLEAN | NO | 有効フラグ（デフォルト: true） |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

#### tag_condition_tags（タグ条件のタグ）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| tag_condition_id | UUID | NO | タグ条件ID（FK） |
| tag_name | VARCHAR(100) | NO | タグ名 |
| created_at | TIMESTAMP | NO | 作成日時 |

#### reply_patterns（返信パターン）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| name | VARCHAR(200) | NO | パターン名 |
| category | VARCHAR(100) | NO | カテゴリ名 |
| keywords | JSONB | YES | 判定キーワード配列 |
| ai_description | TEXT | NO | AI分類用説明文 |
| prompt_template | TEXT | NO | 返信生成プロンプト |
| priority | INTEGER | NO | 優先度（小さいほど高い） |
| is_active | BOOLEAN | NO | 有効フラグ |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |
| deleted_at | TIMESTAMP | YES | 論理削除日時 |

#### messages（受信メッセージ）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| line_user_id | VARCHAR(100) | NO | LINEユーザーID |
| message_content | TEXT | NO | メッセージ内容 |
| received_at | TIMESTAMP | NO | 受信日時 |
| tag_condition_id | UUID | YES | マッチしたタグ条件ID（FK） |
| category | VARCHAR(100) | YES | 分類されたカテゴリ |
| category_confidence | DECIMAL(5,4) | YES | 分類信頼度（0.0000〜1.0000） |
| matched_keywords | JSONB | YES | マッチしたキーワード配列 |
| status | ENUM | NO | ステータス |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

**status の値:**
- `received`: 受信済み
- `classifying`: 分類中
- `classified`: 分類完了
- `generating`: 返信生成中
- `pending_reply`: 返信待ち（30秒待機中）
- `replied`: 返信済み
- `unhandled`: 未対応（分類できず）
- `error`: エラー

#### replies（返信）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| message_id | UUID | NO | メッセージID（FK） |
| reply_content | TEXT | NO | 返信内容 |
| reply_pattern_id | UUID | YES | 使用した返信パターンID（FK） |
| scheduled_at | TIMESTAMP | NO | 送信予定日時 |
| sent_at | TIMESTAMP | YES | 実際の送信日時 |
| status | ENUM | NO | ステータス |
| error_message | TEXT | YES | エラーメッセージ |
| created_at | TIMESTAMP | NO | 作成日時 |

**status の値:**
- `scheduled`: 送信予約済み
- `sent`: 送信完了
- `failed`: 送信失敗

#### message_logs（処理ログ）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| message_id | UUID | NO | メッセージID（FK） |
| log_type | VARCHAR(50) | NO | ログ種別 |
| log_message | TEXT | NO | ログメッセージ |
| metadata | JSONB | YES | 追加メタデータ |
| created_at | TIMESTAMP | NO | 作成日時 |

**log_type の値:**
- `webhook_received`
- `message_saved`
- `classification_started`
- `classification_completed`
- `generation_started`
- `generation_completed`
- `reply_scheduled`
- `reply_sent`
- `error`

#### system_settings（システム設定）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| key | VARCHAR(100) | NO | 設定キー（ユニーク） |
| value | TEXT | NO | 設定値 |
| description | TEXT | YES | 説明 |
| updated_at | TIMESTAMP | NO | 更新日時 |

**設定項目例:**
- `reply_delay_seconds`: 返信遅延秒数（デフォルト: 30）
- `openai_model`: 使用するOpenAIモデル（デフォルト: gpt-4o-mini）
- `lstep_api_key`: Lステップ APIキー（暗号化保存）
- `lstep_webhook_secret`: Webhookシークレット（暗号化保存）

---

## 7. API設計

### 6.1 Webhook受信（Lステップからの受信）

| メソッド | エンドポイント | 説明 |
|----------|---------------|------|
| POST | /api/webhook/lstep | Lステップからのメッセージ受信 |

### 6.2 管理画面用API

| メソッド | エンドポイント | 説明 |
|----------|---------------|------|
| GET | /api/auth/[...nextauth] | 認証（NextAuth.js） |
| GET | /api/dashboard/stats | ダッシュボード統計取得 |
| GET | /api/reply-patterns | 返信パターン一覧取得 |
| POST | /api/reply-patterns | 返信パターン新規登録 |
| GET | /api/reply-patterns/[id] | 返信パターン詳細取得 |
| PUT | /api/reply-patterns/[id] | 返信パターン更新 |
| DELETE | /api/reply-patterns/[id] | 返信パターン削除（論理削除） |
| POST | /api/reply-patterns/test | 返信パターンテスト実行 |
| GET | /api/tag-conditions | タグ条件一覧取得 |
| POST | /api/tag-conditions | タグ条件新規登録 |
| PUT | /api/tag-conditions/[id] | タグ条件更新 |
| DELETE | /api/tag-conditions/[id] | タグ条件削除 |
| GET | /api/messages | メッセージ履歴取得 |
| GET | /api/messages/[id] | メッセージ詳細取得 |
| GET | /api/settings | システム設定取得 |
| PUT | /api/settings | システム設定更新 |

### 6.3 内部処理用API（Cloud Tasks用）

| メソッド | エンドポイント | 説明 |
|----------|---------------|------|
| POST | /api/internal/send-reply | 遅延送信の実行 |

---

## 8. 処理フロー詳細

### 7.1 メッセージ受信〜返信フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    メッセージ処理フロー                          │
└─────────────────────────────────────────────────────────────────┘

1. Webhook受信
   │
   ▼
2. リクエスト検証（署名確認）
   │
   ├─ 検証NG → エラーログ記録 → 終了
   │
   ▼
3. メッセージをDBに保存（status: received）
   │
   ▼
4. キーワードマッチング
   │
   ├─ マッチあり → 候補パターンを絞り込み
   │
   ▼
5. AI分類（OpenAI GPT-4o）
   │
   ├─ 信頼度閾値未満 → status: unhandled → 終了
   │
   ▼
6. カテゴリ・パターン確定（status: classified）
   │
   ▼
7. AI返信文生成（OpenAI GPT-4o）
   │
   ├─ 生成失敗 → status: error → 終了
   │
   ▼
8. 返信をDB保存 + Cloud Tasksに30秒後タスク登録
   │  （status: pending_reply）
   │
   ▼
9. [30秒後] Cloud Tasksがsend-reply APIを呼び出し
   │
   ▼
10. Lステップ APIで返信送信
    │
    ├─ 送信失敗 → リトライ（最大3回）
    │
    ▼
11. 送信結果をDB更新（status: replied or error）
```

### 7.2 AI分類プロンプト例

```
あなたはメッセージ分類AIです。
ユーザーからのメッセージを以下のカテゴリに分類してください。

【カテゴリ一覧】
1. 料金問い合わせ: サービスの料金や価格に関する問い合わせ
2. 予約関連: 予約の確認、変更、キャンセルに関する内容
3. 商品について: 商品の在庫、仕様、詳細に関する問い合わせ
4. 一般問い合わせ: 営業時間、場所、その他一般的な質問
5. その他: 上記に該当しない内容

【ユーザーメッセージ】
{message}

【出力形式】
JSON形式で出力してください:
{
  "category": "カテゴリ名",
  "confidence": 0.0〜1.0の信頼度,
  "reason": "分類理由"
}
```

---

## 9. 外部連携

### 9.1 Lステップ連携

| 項目 | 内容 | 備考 |
|------|------|------|
| Webhook受信 | Lステップ Webhook転送機能を利用 | ✅ 確認済み |
| 返信送信 | Lステップ API または LINE Messaging API | ⚠️ 要確認 |
| Webhook転送料金 | 月額5,500円（税込） | ✅ 確認済み |
| API料金 | LステップPlus⁺® の契約が必要な可能性 | ⚠️ 要確認 |

#### Webhook転送で受信できるデータ

```json
{
  "destination": "xxxxxxxxxx",
  "events": [
    {
      "type": "message",
      "message": {
        "type": "text",
        "id": "14353798921116",
        "text": "料金を教えてください"
      },
      "timestamp": 1625665242211,
      "source": {
        "type": "user",
        "userId": "U80696558e1aa831..."
      },
      "replyToken": "757913772c4646b784d4b7ce46d12671",
      "mode": "active"
    }
  ]
}
```

**注意**: 上記はLINE公式アカウントのWebhookフォーマット。Lステップ独自のタグ情報等は含まれない。

### 9.2 LINE Messaging API（代替案として）

| 項目 | 内容 |
|------|------|
| Push Message | ユーザーに能動的にメッセージを送信 |
| Reply Token | Webhook受信後、**約1分以内**のみ有効 |
| 30秒後返信 | Reply Tokenが失効するため、**Push Message を使用** |
| 料金 | LINE公式アカウントのメッセージ配信数に依存 |

**注意**: LINE Messaging APIで返信した場合、Lステップ上の会話履歴に反映されない可能性がある。

### 9.3 OpenAI API

| 項目 | 内容 |
|------|------|
| 用途 | メッセージ分類、返信文生成 |
| モデル | GPT-4o-mini（コスト効率重視）またはGPT-4o |
| 想定コスト | 500〜1000件/日 × 2回呼び出し ≒ $50〜100/月 |
| フォールバック | レスポンス遅延時はタイムアウト処理 |

---

## 10. 非機能要件

### 9.1 性能要件

| 項目 | 要件 |
|------|------|
| Webhook応答時間 | 3秒以内（202 Acceptedを即座に返す） |
| AI処理時間 | 分類 + 生成で10秒以内 |
| 返信遅延精度 | 30秒 ± 5秒 |
| 同時処理数 | 100件/分 |

### 9.2 可用性要件

| 項目 | 要件 |
|------|------|
| 稼働率 | 99.9%以上 |
| 障害復旧時間 | 1時間以内 |

### 9.3 セキュリティ要件

| 項目 | 要件 |
|------|------|
| 認証 | Google OAuth（管理画面） |
| Webhook検証 | 署名検証必須 |
| APIキー管理 | Secret Managerで暗号化保存 |
| 通信 | HTTPS必須 |
| 個人情報 | LINEユーザーIDは暗号化保存 |

---

## 11. GCPコスト見積もり（月額）

| サービス | 見積もり | 備考 |
|----------|---------|------|
| Cloud Run | $20〜50 | メイン + ワーカー |
| Cloud SQL (PostgreSQL) | $15〜25 | db-f1-micro〜db-g1-small |
| Cloud Tasks | $0〜5 | 30,000タスク/月 |
| OpenAI API | $50〜100 | GPT-4o-mini想定 |
| Lステップ Webhook転送 | ¥5,500 | 固定費用 |
| **合計** | **$85〜180 + ¥5,500/月** | |

---

## 12. 開発スケジュール（目安）

| フェーズ | タスク | 期間 |
|----------|--------|------|
| Phase 1 | 環境構築・プロジェクト初期設定 | 1日 |
| Phase 2 | データベース設計・Prismaセットアップ | 1日 |
| Phase 3 | Webhook受信・メッセージ保存 | 2日 |
| Phase 4 | AI分類機能（OpenAI連携） | 2日 |
| Phase 5 | AI返信生成機能 | 2日 |
| Phase 6 | 30秒遅延送信（Cloud Tasks） | 2日 |
| Phase 7 | Lステップ API連携（返信送信） | 2日 |
| Phase 8 | 管理画面UI実装 | 5日 |
| Phase 9 | テスト・デバッグ | 3日 |
| Phase 10 | GCPデプロイ | 2日 |
| **合計** | | **約22日** |

---

## 13. リスクと対策

### 13.1 技術的リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Lステップ API仕様が非公開 | 🔴 高 | 開発前にLステップサポートへ確認、PoCを実施 |
| タグ情報がWebhookで取得不可 | 🔴 高 | 方式A/B/Cの検証、代替案の準備 |
| OpenAI API障害 | 🟡 中 | タイムアウト設定、返信せず放置の仕様で対応 |
| 30秒遅延の精度ずれ | 🟢 低 | Cloud Tasksの動作検証、許容範囲±5秒 |
| AI分類精度の低下 | 🟡 中 | 定期的なパターン見直し、信頼度閾値の調整 |

### 13.2 ビジネスリスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| LステップPlus⁺®の追加費用 | 🟡 中 | 事前に見積もり取得、予算確保 |
| Lステップサービス変更 | 🟡 中 | 代替案（LINE Messaging API直接利用）を準備 |
| LINE公式アカウントのメッセージ制限 | 🟡 中 | 料金プランの確認、Push Message数の監視 |
| コスト超過 | 🟢 低 | 使用量監視、アラート設定 |

### 13.3 開発着手前のリスク軽減策

```
【必須アクション】
1. Lステップサポートへの問い合わせ（1週間以内）
   - API仕様書の取得
   - タグ条件フィルターの可否確認
   - LステップPlus⁺®の料金確認

2. PoC実施（確認後1週間）
   - Webhook転送のテスト
   - 受信データの確認
   - API動作確認（利用可能な場合）

3. 方式確定（PoC完了後）
   - 方式A/B/Cのいずれかを選択
   - 本要件定義書を更新
   - 開発着手
```

---

## 14. 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|------------|------|----------|--------|
| 1.0 | 2025/11/26 | 初版作成 | |
| 1.1 | 2025/11/26 | Lステップ API調査結果を追記、実現可能性検証セクション追加、リスク対策を詳細化 | |

