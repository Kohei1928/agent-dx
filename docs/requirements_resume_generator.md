# 要件定義書: 履歴書・職務経歴書自動生成システム

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Resume Generator for HR Agents |
| 作成日 | 2025年11月27日 |
| バージョン | 2.0 |

### 1.1 目的
人材エージェントのCA（キャリアアドバイザー）が、求職者の履歴書・職務経歴書を作成する業務を自動化するシステムを開発する。

### 1.2 背景
- CAは求職者ごとに履歴書・職務経歴書を毎回手作業で作成しており、多大な時間がかかっている
- アンケートデータと面談の文字起こしデータから情報を手動で抽出・整理している
- この作業を自動化することで、CAの業務効率を大幅に向上させる

### 1.3 利用者
- キャリアアドバイザー（CA）：約10名
- ログイン制限：`@migi-nanameue.co.jp` ドメインのみ

---

## 2. システム概要

### 2.1 処理フロー

```
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ アンケートデータ  │  │ HubSpotコンタクト │  │ 面談文字起こし   │
│ （正規化データ）  │  │ （設定でマッピング）│  │ （非正規データ）  │
│ 【優先度: 最高】  │  │ 【優先度: 中】    │  │ 【優先度: 低】   │
└────────┬────────┘  └────────┬────────┘  └────────┬────────┘
         │                    │                    │
         └────────────────────┼────────────────────┘
                              ▼
                    ┌─────────────────────┐
                    │  データ統合エンジン   │
                    │  ・優先度に基づく統合  │
                    │  ・不足項目をAIで補完  │
                    └──────────┬──────────┘
                               ▼
                    ┌─────────────────────┐
                    │   LLM による解析     │
                    │  ・情報抽出（面談）   │
                    │  ・文章生成          │
                    └──────────┬──────────┘
                               ▼
                    ┌─────────────────────┐
                    │  エディタ画面で表示   │
                    │  ・リアルタイム編集   │
                    │  ・PDFプレビュー     │
                    └──────────┬──────────┘
                               ▼
                    ┌─────────────────────┐
                    │  PDF出力・保存       │
                    │  ・履歴書PDF         │
                    │  ・職務経歴書PDF     │
                    └─────────────────────┘
```

### 2.2 データソース優先度

| 優先度 | データソース | 説明 |
|--------|-------------|------|
| 1（最高） | 正規データ（アンケート） | CAが直接入力した最も信頼性の高いデータ |
| 2（中） | HubSpotコンタクト | 設定でマッピングした項目から取得 |
| 3（低） | 面談文字起こし | 上記で不足している情報をAIが抽出 |

**データ統合ルール：**
- 同じ項目に複数のデータソースから値がある場合、優先度の高いものを採用
- 正規データが空の場合のみ、HubSpotデータを使用
- HubSpotデータも空の場合のみ、面談データからAIで抽出

### 2.3 入力データ

| データ種別 | 形式 | 説明 | 優先度 |
|-----------|------|------|--------|
| アンケートデータ | 自然言語テキスト | 氏名、住所、学歴、職歴など（項目がない場合もあり） | 最高 |
| HubSpotコンタクト | API連携 | 設定でマッピングした項目を自動取得 | 中 |
| 面談文字起こし | テキスト | Google Meet録音 → Geminiで文字起こし → コピー＆ペースト | 低 |

### 2.4 出力データ

| 出力物 | 形式 | 説明 |
|--------|------|------|
| 履歴書 | PDF | JIS規格準拠（顔写真欄あり） |
| 職務経歴書 | PDF | 1〜3ページ構成 |

---

## 3. 履歴書仕様（JIS規格準拠）

**参考フォーマット: 和田真由子様の履歴書**

### 3.1 レイアウト構成

```
┌─────────────────────────────────────────────────────────────────┐
│                       履 歴 書                                   │
│                                              20XX年XX月XX日現在  │
├───────────────────────────────────────────┬─────────────────────┤
│ フリガナ: ○○○ ○○○○                       │   ┌─────────────┐   │
│ 氏  名: ○○ ○○○○             性別: 男・女 │   │             │   │
├───────────────────────────────────────────┤   │   顔 写 真   │   │
│ 生年月日: XXXX年XX月XX日生（満XX歳）       │   │  縦4×横3cm  │   │
├───────────────────────────────────────────┤   │             │   │
│ ふりがな: ○○○○○○○○○                     │   └─────────────┘   │
│ 現住所: 〒XXX-XXXX                         │ 電話: XXX-XXXX-XXXX│
│ ○○県○○市○○町X-X-X                        │ E-mail: xxx@xxx.xx │
├───────────────────────────────────────────┴─────────────────────┤
│ 年    │ 月 │ 学歴・職歴                                         │
├───────┼────┼─────────────────────────────────────────────────────┤
│       │    │ 【学歴】                                            │
│ 20XX  │  4 │ ○○高等学校 入学                                    │
│ 20XX  │  3 │ ○○高等学校 卒業                                    │
│ 20XX  │  4 │ ○○大学○○学部○○学科 入学                           │
│ 20XX  │  3 │ ○○大学○○学部○○学科 卒業                           │
│       │    │ 【職歴】                                            │
│ 20XX  │  4 │ 株式会社○○ 入社                                    │
│       │    │ ○○部にて営業職に従事                                │
│ 20XX  │ XX │ 一身上の都合により退職                              │
│       │    │                                        以上         │
├─────────────────────────────────────────────────────────────────┤
│ 年    │ 月 │ 免許・資格                                          │
├───────┼────┼─────────────────────────────────────────────────────┤
│ 20XX  │ XX │ 普通自動車第一種運転免許 取得                        │
│ 20XX  │ XX │ ○○○○検定○級 合格                                   │
├─────────────────────────────────────────────────────────────────┤
│ 本人希望欄                                                       │
│ 特になし（貴社規定に従います）                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 フォーム入力項目

| セクション | フィールド | 型 | 必須 |
|-----------|-----------|-----|-----|
| 基本情報 | 氏名 | text | ✅ |
| | ふりがな | text | ✅ |
| | 性別 | select (男/女/その他) | - |
| | 生年月日 | date | ✅ |
| | 郵便番号 | text | - |
| | 住所 | text | ✅ |
| | 電話番号 | text | ✅ |
| | メールアドレス | text | - |
| | 顔写真 | file (JPG/PNG) | - |
| 学歴 | 年 | number | ✅ |
| | 月 | number | ✅ |
| | 内容 | text | ✅ |
| | （複数行追加可能） | | |
| 職歴 | 年 | number | - |
| | 月 | number | - |
| | 内容 | text | - |
| | （複数行追加可能） | | |
| 免許・資格 | 年 | number | - |
| | 月 | number | - |
| | 資格名 | text | - |
| | （複数行追加可能） | | |
| 本人希望欄 | 内容 | textarea | - |

### 3.3 顔写真仕様

| 項目 | 仕様 |
|------|------|
| サイズ | 縦4cm × 横3cm |
| 形式 | JPG, PNG |
| 最大ファイルサイズ | 5MB |
| 保存先 | Google Cloud Storage |
| 表示位置 | 履歴書右上 |

---

## 4. 職務経歴書仕様

**参考フォーマット: 大堀竣様の職務経歴書**

### 4.1 レイアウト構成

```
┌─────────────────────────────────────────────────────────────────┐
│                       職 務 経 歴 書                             │
│                                                                  │
│                           20XX年XX月XX日  氏名: ○○ ○○           │
├─────────────────────────────────────────────────────────────────┤
│ ■職務要約                                                        │
│ ○○大学卒業後、株式会社○○に入社し、約X年間にわたり...            │
│ （200〜300文字程度の要約）                                        │
├─────────────────────────────────────────────────────────────────┤
│ ■職務経歴                                                        │
│                                                                  │
│ ○株式会社○○○○                                                  │
│ 事業内容: ○○○○  設立: XXXX年X月  資本金: ○○万円                 │
│ 従業員数: 約○○名                                                 │
│ ┌─────────────┬───────────────────────────────────────────────┐ │
│ │   期間      │ 業務内容                                       │ │
│ ├─────────────┼───────────────────────────────────────────────┤ │
│ │ 20XX年X月   │【業務内容】                                    │ │
│ │ ～          │・○○○○○○○○                                     │ │
│ │ 現在        │・○○○○○○○○                                     │ │
│ │             │【成果】                                        │ │
│ │             │・目標○○に対し達成率○○%                         │ │
│ │             │【取り組み】                                    │ │
│ │             │・○○○○を実施し、○○を達成                        │ │
│ └─────────────┴───────────────────────────────────────────────┘ │
│ （以下、各社ごとに繰り返し ※直近から古い順）                       │
├─────────────────────────────────────────────────────────────────┤
│ ■活かせる経験・知識・技術                                        │
│ ・○○の経験                                                      │
│ ・○○の知識                                                      │
├─────────────────────────────────────────────────────────────────┤
│ ■自己PR                                                         │
│ 【強みのタイトル】                                               │
│ ○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○  │
│ （400文字程度）                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 フォーム入力項目

| セクション | フィールド | 型 | 必須 | 備考 |
|-----------|-----------|-----|-----|------|
| 基本情報 | 氏名 | text | ✅ | 履歴書と共通 |
| | 作成日 | date | ✅ | 自動で当日 |
| 職務要約 | 要約文 | textarea | ✅ | AI生成後編集可 |
| 職務経歴（会社ごと） | 会社名 | text | ✅ | |
| | 事業内容 | text | - | 手動入力 |
| | 設立年 | text | - | 手動入力 |
| | 資本金 | text | - | 手動入力 |
| | 従業員数 | text | - | 手動入力 |
| | 在籍期間 | text | ✅ | 例: 2020年4月〜現在 |
| | 業務内容 | richtext | ✅ | 太字・箇条書き対応 |
| | 成果 | richtext | - | 太字・箇条書き対応 |
| | 取り組み | richtext | - | 太字・箇条書き対応 |
| 活かせる経験 | 項目 | array | - | 複数追加可能 |
| 自己PR | タイトル | text | ✅ | |
| | 本文 | textarea | ✅ | 約400文字 |

### 4.3 職務経歴の順序

| 項目 | 仕様 |
|------|------|
| 表示順 | **直近から古い順（逆時系列）** |
| 最大ページ数 | **3ページ** |
| 会社情報 | **手動入力のみ**（AIによる自動検索なし） |

---

## 5. 画面設計

### 5.1 画面一覧

| 画面ID | 画面名 | 説明 |
|--------|--------|------|
| P-001 | ログイン画面 | Google OAuth認証でログイン |
| P-002 | ダッシュボード | 最近の活動・統計情報を表示 |
| P-003 | 求職者一覧画面 | 登録済み求職者の一覧表示・検索 |
| P-004 | 求職者登録画面 | 新規求職者の基本情報入力 |
| P-005 | 求職者詳細画面 | 求職者情報の表示・編集 |
| P-006 | データ入力画面 | アンケートデータ・面談データの入力 |
| P-006b | 企業情報入力画面 | 志望動機生成用の企業情報入力 |
| **P-100** | **履歴書エディタ画面** | 履歴書の編集・PDFプレビュー |
| **P-101** | **職務経歴書エディタ画面** | 職務経歴書の編集・PDFプレビュー |
| P-009 | 生成履歴画面 | 過去の生成履歴一覧 |
| P-010 | HubSpotコンタクト選択画面 | メールで照合してコンタクトを選択 |
| P-011 | HubSpot項目マッピング設定画面 | HubSpot項目と履歴書項目の紐づけ設定 |

### 5.2 画面遷移図

```
[ログイン画面]
      │
      ▼
[ダッシュボード] ──┬──→ [求職者一覧画面] ──→ [求職者詳細画面]
                  │                              │
                  │                              ├──→ [データ入力画面]
                  │                              │
                  │                              ├──→ [履歴書・職務経歴書を生成]
                  │                              │           │
                  │                              │           ▼
                  │                              │    ┌─────────────────────┐
                  │                              │    │ AI生成処理（Gemini） │
                  │                              │    └──────────┬──────────┘
                  │                              │               ▼
                  │                              │    ┌─────────────────────┐
                  │                              │    │ エディタ画面（タブ）  │
                  │                              │    │ ・履歴書タブ         │
                  │                              │    │ ・職務経歴書タブ      │
                  │                              │    └──────────┬──────────┘
                  │                              │               │
                  │                              │    [保存] [PDFダウンロード]
                  │                              │
                  │                              └──→ [生成履歴画面]
                  │
                  ├──→ [求職者登録画面]
                  │
                  └──→ [HubSpot項目マッピング設定画面]
```

### 5.3 エディタ画面（P-100/P-101）

```
┌──────────────────────────────────────────────────────────────────────────┐
│  Resume Generator                              [ユーザー名] [ログアウト]    │
├──────────────────────────────────────────────────────────────────────────┤
│  ← 田中太郎さんの詳細に戻る                                                │
│                                                                          │
│  📄 履歴書・職務経歴書エディタ                                             │
│                                                                          │
│  ┌──────────────────────┐  ┌─────────────────────────────────────────┐   │
│  │ [履歴書] [職務経歴書] │  │                                         │   │
│  └──────────────────────┘  │                                         │   │
│                             │                                         │   │
│  ┌─────────────────────┐   │          PDFプレビュー                   │   │
│  │ 📷 顔写真            │   │                                         │   │
│  │ [画像アップロード]    │   │    ┌───────────────────────────────┐   │   │
│  │ ┌───────────────┐    │   │    │                               │   │   │
│  │ │               │    │   │    │      履 歴 書                 │   │   │
│  │ │   プレビュー   │    │   │    │                               │   │   │
│  │ │               │    │   │    │   フリガナ: ○○○              │   │   │
│  │ └───────────────┘    │   │    │   氏名: ○○ ○○               │   │   │
│  └─────────────────────┘   │    │   ...                          │   │   │
│                             │    │                               │   │   │
│  氏名 *                     │    │                               │   │   │
│  ┌─────────────────────┐   │    │                               │   │   │
│  │ 田中 太郎           │   │    │                               │   │   │
│  └─────────────────────┘   │    │                               │   │   │
│                             │    │                               │   │   │
│  ふりがな *                 │    │                               │   │   │
│  ┌─────────────────────┐   │    │                               │   │   │
│  │ たなか たろう        │   │    │                               │   │   │
│  └─────────────────────┘   │    └───────────────────────────────┘   │   │
│                             │                                         │   │
│  生年月日 *                 │                                         │   │
│  ┌─────────────────────┐   │                                         │   │
│  │ 1990/01/15          │   │                                         │   │
│  └─────────────────────┘   │                                         │   │
│                             │                                         │   │
│  （以下、フォーム続く）      │                                         │   │
│                             │                                         │   │
│  ─────────────────────────  │                                         │   │
│  学歴                       │                                         │   │
│  ┌────┬────┬───────────┐   │                                         │   │
│  │年  │月  │ 内容      │   │                                         │   │
│  ├────┼────┼───────────┤   │                                         │   │
│  │2009│ 4  │○○高校 入学│   │                                         │   │
│  │2012│ 3  │○○高校 卒業│   │                                         │   │
│  │    │    │ [+行追加] │   │                                         │   │
│  └────┴────┴───────────┘   │                                         │   │
│                             │                                         │   │
│  ─────────────────────────  └─────────────────────────────────────────┘   │
│                                                                          │
│                            [💾 保存]  [📥 PDFダウンロード]               │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 5.4 職務経歴書エディタ（P-101）の特徴

```
┌──────────────────────────────────────────────────────────────────────────┐
│  職務経歴（リッチテキストエディタ）                                        │
│                                                                          │
│  ○株式会社ヘイフィールド                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ 事業内容: [人材紹介事業、インターネットメディア事業            ]     │ │
│  │ 設立:     [2019年4月    ]  資本金: [399万円    ]                    │ │
│  │ 従業員数: [約60名       ]                                           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  期間: [2022年7月 ～ 現在                           ]                    │
│                                                                          │
│  業務内容: （リッチテキストエディタ）                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ [B] [I] [・] [1.] [━]                              ← ツールバー     │ │
│  ├─────────────────────────────────────────────────────────────────────┤ │
│  │ 【業務内容】                                                        │ │
│  │ キャリアアドバイザーとして、主に不動産業界の転職希望者の              │ │
│  │ 支援業務全般に従事。                                                │ │
│  │ ・新規登録者および既存登録者へのカウンセリング                       │ │
│  │ ・キャリアプランニングの提案、求人紹介                               │ │
│  │ ・応募書類の添削                                                    │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  成果: （リッチテキストエディタ）                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ 【成果】                                                            │ │
│  │ ・2023年上期：売上目標1500万円に対し85%達成                          │ │
│  │ ・2023年下期：売上目標1500万円に対し96%達成                          │ │
│  │ ・2024年上期：売上目標1500万円に対し105%達成                         │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  [+ 会社を追加]                                                          │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 6. データベース設計

### 6.1 テーブル一覧

| テーブル名 | 説明 |
|-----------|------|
| users | CAユーザー情報 |
| job_seekers | 求職者情報 |
| questionnaire_data | アンケートデータ |
| interview_transcripts | 面談文字起こしデータ |
| resume_data | 履歴書フォームデータ（JSON） |
| cv_data | 職務経歴書フォームデータ（JSON） |
| target_companies | 応募先企業情報（志望動機生成用） |
| generation_logs | 生成履歴 |
| hubspot_mappings | HubSpot項目マッピング設定 |
| photos | 顔写真データ |

### 6.2 新規テーブル

#### resume_data テーブル（履歴書フォームデータ）

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| id | UUID | NO | 主キー |
| job_seeker_id | UUID | NO | 求職者ID（FK） |
| name | VARCHAR(100) | YES | 氏名 |
| name_kana | VARCHAR(100) | YES | ふりがな |
| gender | VARCHAR(10) | YES | 性別 |
| birth_date | DATE | YES | 生年月日 |
| postal_code | VARCHAR(10) | YES | 郵便番号 |
| address | TEXT | YES | 住所 |
| phone | VARCHAR(20) | YES | 電話番号 |
| email | VARCHAR(255) | YES | メールアドレス |
| photo_url | VARCHAR(500) | YES | 顔写真URL（GCS） |
| education | JSON | YES | 学歴（配列） |
| work_history | JSON | YES | 職歴（配列） |
| qualifications | JSON | YES | 免許・資格（配列） |
| preferences | TEXT | YES | 本人希望欄 |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

#### cv_data テーブル（職務経歴書フォームデータ）

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| id | UUID | NO | 主キー |
| job_seeker_id | UUID | NO | 求職者ID（FK） |
| name | VARCHAR(100) | YES | 氏名 |
| created_date | DATE | YES | 作成日 |
| summary | TEXT | YES | 職務要約 |
| work_history | JSON | YES | 職務経歴（会社ごと、リッチテキスト含む） |
| skills | JSON | YES | 活かせる経験・スキル（配列） |
| self_pr_title | VARCHAR(200) | YES | 自己PRタイトル |
| self_pr | TEXT | YES | 自己PR本文 |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

**work_history JSON構造:**
```json
[
  {
    "companyName": "株式会社ヘイフィールド",
    "businessContent": "人材紹介事業、インターネットメディア事業",
    "established": "2019年4月",
    "capital": "399万円",
    "employees": "約60名",
    "period": "2022年7月〜現在",
    "content": "<p><strong>【業務内容】</strong></p><ul><li>キャリアアドバイザーとして...</li></ul>",
    "achievements": "<p>【成果】</p><ul><li>売上目標達成率105%</li></ul>",
    "initiatives": "<p>【取り組み】</p><ul><li>面談実施数の最大化</li></ul>"
  }
]
```

---

## 7. 技術要件

### 7.1 技術スタック

| レイヤー | 技術 | 備考 |
|----------|------|------|
| フロントエンド | Next.js 14 (App Router), React, Tailwind CSS | |
| バックエンド | Next.js API Routes (Route Handlers) | |
| ORM | Prisma | |
| データベース | PostgreSQL (GCP Cloud SQL) | |
| 認証 | NextAuth.js (Google OAuth) | @migi-nanameue.co.jp のみ |
| LLM | Google Gemini API (gemini-2.0-flash) | |
| **PDF生成** | **@react-pdf/renderer** | 日本語フォント設定必要 |
| **リッチテキストエディタ** | **TipTap** | 職務経歴書の編集用 |
| **画像ストレージ** | **Google Cloud Storage** | 顔写真保存 |
| インフラ | GCP Cloud Run | |

### 7.2 PDF生成仕様

| 項目 | 仕様 |
|------|------|
| ライブラリ | @react-pdf/renderer |
| 日本語フォント | Noto Sans JP |
| 出力サイズ | A4 |
| 履歴書ページ数 | 1〜2ページ |
| 職務経歴書ページ数 | 最大3ページ |

### 7.3 リッチテキストエディタ仕様

| 項目 | 仕様 |
|------|------|
| ライブラリ | TipTap |
| 対応フォーマット | 太字、箇条書き（・）、番号付きリスト、区切り線 |
| 保存形式 | HTML |
| PDF変換 | HTMLをパースしてPDFスタイルに変換 |

---

## 8. API設計

### 8.1 エンドポイント一覧（追加分）

| メソッド | エンドポイント | 説明 |
|----------|---------------|------|
| GET | /api/job-seekers/[id]/resume | 履歴書データ取得 |
| PUT | /api/job-seekers/[id]/resume | 履歴書データ保存 |
| GET | /api/job-seekers/[id]/cv | 職務経歴書データ取得 |
| PUT | /api/job-seekers/[id]/cv | 職務経歴書データ保存 |
| POST | /api/job-seekers/[id]/photo | 顔写真アップロード |
| DELETE | /api/job-seekers/[id]/photo | 顔写真削除 |
| POST | /api/job-seekers/[id]/generate | AI生成実行（データを自動入力） |
| GET | /api/job-seekers/[id]/resume/pdf | 履歴書PDFダウンロード |
| GET | /api/job-seekers/[id]/cv/pdf | 職務経歴書PDFダウンロード |

---

## 9. 機能要件

### 9.1 ドキュメント生成・編集機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F-301 | AI自動入力 | アンケート/面談/HubSpotデータからAIで各フィールドに自動入力 |
| F-302 | 履歴書フォーム編集 | フォーム形式で各項目を編集 |
| F-303 | 職務経歴書リッチテキスト編集 | TipTapで業務内容・成果・取り組みを編集 |
| F-304 | 顔写真アップロード | JPG/PNGをGCSにアップロード |
| F-305 | PDFプレビュー | リアルタイムでPDFプレビュー表示 |
| F-306 | PDF出力 | 履歴書・職務経歴書をPDFでダウンロード |
| F-307 | データ保存 | 編集内容をDBに保存（再編集可能） |
| F-308 | 志望動機生成 | 企業情報を元に約400文字の志望動機を生成 |

---

## 10. ユースケース

### UC-005: 履歴書・職務経歴書生成・編集

```
【事前条件】
- CAがログイン済み
- 求職者が登録済み
- アンケートデータまたは面談データが入力済み

【基本フロー】
1. CAが求職者詳細画面で「履歴書・職務経歴書を生成」ボタンをクリック
2. システムが3つのデータソースを優先度順に統合
3. Gemini APIで情報を解析・抽出
4. **エディタ画面が開き、AIが各フィールドに自動入力**
5. CAがフォームで内容を確認・編集
6. CAが顔写真をアップロード（任意）
7. 「保存」ボタンでDBに保存
8. 「PDFダウンロード」ボタンでPDF出力

【代替フロー】
- 5a. 保存後、再度エディタ画面を開いて再編集可能
- 7a. 職務経歴書タブに切り替えて職務経歴書を編集

【事後条件】
- 履歴書・職務経歴書のデータがDBに保存されている
- PDFがダウンロード可能
```

---

## 11. 日程調整機能

### 11.1 概要

求職者の面接日程を企業と調整するための機能。CAが日程候補を登録し、共有URLを企業に送付。企業は認証なしで空き日程から選択・確定できる。

### 11.2 機能一覧

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| S-001 | 日程候補登録 | 週次カレンダーUIでドラッグ選択して日程候補を一括登録 |
| S-002 | 日程候補編集 | 登録済み日程の時間・形式の変更 |
| S-003 | 日程NG化 | 日程候補を無効化（論理削除） |
| S-004 | 共有URL発行 | 企業向けの認証不要URLを発行（有効期限なし） |
| S-005 | 企業向け日程選択 | 企業が共有URLから空き日程を選択・確定 |
| S-006 | 対面面接ブロック | 対面面接確定時、前後1時間の日程を自動ブロック |
| S-007 | 確定通知 | 日程確定時にCA（登録者）へメール・Slack DM通知 |
| S-008 | URLコピー | 求職者一覧から共有URLをワンクリックでコピー |

### 11.3 日程候補登録UI

```
┌─────────────────────────────────────────────────────────────────┐
│                    📅 日程候補を追加                              │
│  ◀ 前の週    11/25 〜 12/1    次の週 ▶                          │
├─────────────────────────────────────────────────────────────────┤
│        │ 月 25 │ 火 26 │ 水 27 │ 木 28 │ 金 29 │ 土 30 │ 日 1  │
│  7:00  │       │       │       │       │       │       │       │
│  7:30  │       │       │       │       │       │       │       │
│  8:00  │ ████  │       │       │       │       │       │       │
│  8:30  │ ████  │       │ ████  │       │       │       │       │
│  9:00  │ ████  │       │ ████  │       │       │       │       │
│   ...  │       │       │       │       │       │       │       │
│ 23:00  │       │       │       │       │       │       │       │
├─────────────────────────────────────────────────────────────────┤
│  選択中の日程候補（3件）                                          │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 11/25(月) 08:00〜10:00 [×]  │ 11/27(水) 08:30〜09:30 [×] │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  💡 PC: ドラッグで選択 / スマホ: ロングタップ後スライド           │
└─────────────────────────────────────────────────────────────────┘
```

**操作方法:**
- **PC**: クリック＆ドラッグで時間範囲を選択
- **スマホ**: ロングタップ（300ms）後にスライドで選択
- 選択済みセルをクリックで削除
- 30分単位のグリッド
- 時間軸: 7:00〜23:00

### 11.4 日程管理画面

| セクション | 内容 |
|-----------|------|
| 共有URL | URL表示、コピーボタン |
| タブ切り替え | カレンダーで追加 / 一覧表示 |
| 日程一覧 | 日付、時間、形式、ステータス、操作ボタン |
| 確定履歴 | 企業名、日時、形式、確定日時、状態 |

**ステータス:**
| ステータス | 説明 | 色 |
|-----------|------|-----|
| 🟢 空き | 選択可能 | 緑 |
| 🔴 確定 | 企業が選択済み | 赤 |
| 🟡 ブロック | 対面面接の前後1時間 | 黄 |
| ⚫ NG | キャンセル済み | グレー |

### 11.5 企業向け公開ページ

**URL形式:** `/schedule/{token}`

```
┌─────────────────────────────────────────────────────────────────┐
│                       📅 日程選択                                │
│                                                                  │
│  田中太郎様の面接日程を選択してください                            │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ ○ 11/25(月) 10:00〜11:00  📹 オンライン                     ││
│  │ ○ 11/26(火) 14:00〜15:00  🏢 対面                          ││
│  │ ● 11/27(水) 09:00〜10:00  📹 オンライン  ← 選択中           ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  企業名: [株式会社○○                                    ]       │
│                                                                  │
│                    [この日程で確定する]                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 11.6 データベース設計（追加テーブル）

#### schedules テーブル

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| id | UUID | NO | 主キー |
| job_seeker_id | UUID | NO | 求職者ID（FK） |
| date | DATE | NO | 日付 |
| start_time | VARCHAR(5) | NO | 開始時刻（HH:MM） |
| end_time | VARCHAR(5) | NO | 終了時刻（HH:MM） |
| interview_type | ENUM | NO | online / onsite |
| status | ENUM | NO | available / booked / blocked / cancelled |
| blocked_by_id | UUID | YES | ブロック元の日程ID |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

#### schedule_bookings テーブル

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| id | UUID | NO | 主キー |
| schedule_id | UUID | NO | 日程ID（FK、UNIQUE） |
| job_seeker_id | UUID | NO | 求職者ID（FK） |
| company_name | VARCHAR(255) | NO | 企業名（手入力） |
| confirmed_at | TIMESTAMP | NO | 確定日時 |
| cancelled_at | TIMESTAMP | YES | キャンセル日時 |
| cancel_reason | TEXT | YES | キャンセル理由 |

#### job_seekers テーブル（追加カラム）

| カラム名 | 型 | NULL | 説明 |
|----------|-----|------|------|
| schedule_token | VARCHAR(50) | YES | 共有URL用トークン（UNIQUE、自動生成） |

### 11.7 API設計（日程調整）

| メソッド | エンドポイント | 認証 | 説明 |
|----------|---------------|------|------|
| GET | /api/job-seekers/[id]/schedules | 要 | 日程候補一覧取得 |
| POST | /api/job-seekers/[id]/schedules | 要 | 日程候補追加（単体） |
| POST | /api/job-seekers/[id]/schedules/bulk | 要 | 日程候補一括追加 |
| PUT | /api/schedules/[id] | 要 | 日程編集 |
| POST | /api/schedules/[id]/cancel | 要 | 日程NG化 |
| POST | /api/schedules/[id]/cancel-booking | 要 | 予約キャンセル |
| GET | /api/job-seekers/[id]/bookings | 要 | 確定履歴取得 |
| GET | /api/public/schedule/[token] | 不要 | 公開：空き日程取得 |
| POST | /api/public/schedule/[token]/book | 不要 | 公開：日程確定 |

### 11.8 通知機能

| 通知種類 | トリガー | 通知先 | 内容 |
|----------|---------|--------|------|
| メール | 日程確定時 | 登録したCA | 候補者名、企業名、日時、形式 |
| Slack DM | 日程確定時 | 登録したCA（slackUserId設定時） | 同上（Block Kit形式） |

**Slack DM通知の前提条件:**
- 環境変数 `SLACK_BOT_TOKEN` が設定されていること
- Userモデルの `slackUserId` が設定されていること

---

## 12. 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|------------|------|----------|--------|
| 1.0 | 2025/11/26 | 初版作成 | |
| 1.1 | 2025/11/27 | HubSpot連携・データ優先度の詳細追加 | |
| 1.2 | 2025/11/27 | Googleドキュメント出力仕様追加 | |
| 2.0 | 2025/11/28 | Google Docs API → PDF出力方式に変更。JIS規格履歴書（顔写真欄）、職務経歴書（リッチテキスト、最大3ページ、逆時系列）、@react-pdf/renderer、TipTap、GCS導入 | |
| **2.1** | **2025/11/28** | **日程調整機能追加。週次カレンダーUI（Spir/TimeRex風）、企業向け共有URL（期限なし）、対面面接時の前後ブロック、メール・Slack DM通知** | |

---

## 13. 参考資料

- 履歴書フォーマット参考: 和田真由子様の履歴書
- 職務経歴書フォーマット参考: 大堀竣様の職務経歴書

---

## 14. 承認

| 役割 | 氏名 | 日付 | 署名 |
|------|------|------|------|
| 作成者 | | 2025/11/28 | |
| 承認者 | | | |
