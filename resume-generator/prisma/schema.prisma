// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth用モデル
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// CAユーザー情報
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  slackUserId   String?   @db.VarChar(20)  // Slack DM通知用
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts       Account[]
  sessions       Session[]
  jobSeekers     JobSeeker[]
  generationLogs GenerationLog[]
  selections     Selection[]     // 担当選考
  caProfile      CAProfile?      // CA権限情報
}

// 求職者情報
model JobSeeker {
  id                  String    @id @default(cuid())
  userId              String
  name                String
  nameKana            String?
  email               String?
  phone               String?
  gender              String?   @db.VarChar(10)  // 性別
  birthDate           DateTime?
  address             String?
  notes               String?   @db.Text
  hubspotContactId    String?
  hubspotContactEmail String?
  hubspotData         Json?
  hubspotSyncedAt     DateTime?
  // 日程調整用URL
  scheduleToken       String?   @unique @default(cuid())
  scheduleUrlExpiresAt DateTime?
  // フォーム用URL
  formToken           String?   @unique @default(cuid())
  // 非表示フラグ
  isHidden            Boolean   @default(false)
  // 面接前後のブロック時間設定（分）- マイグレーション後に有効化
  // onsiteBlockMinutes  Int       @default(60)   // 対面面接: デフォルト1時間
  // onlineBlockMinutes  Int       @default(30)   // オンライン面接: デフォルト30分
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  registeredBy         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionnaireData    QuestionnaireData?
  interviewTranscript  InterviewTranscript?
  targetCompany        TargetCompany?
  generatedDocuments   GeneratedDocument[]
  generationLogs       GenerationLog[]
  resumeData           ResumeData?
  cvData               CvData?
  schedules            Schedule[]
  scheduleBookings     ScheduleBooking[]
  recommendationLetter RecommendationLetter?
  selections           Selection[]           // この求職者の選考一覧
  proposals            Proposal[]            // この求職者への提案表

  @@index([userId])
  @@index([email])
  @@index([scheduleToken])
  @@index([scheduleUrlExpiresAt])
  @@index([formToken])
}

// アンケートデータ（正規化データ）
model QuestionnaireData {
  id          String   @id @default(cuid())
  jobSeekerId String   @unique
  content     String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  jobSeeker JobSeeker @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)
}

// 面談文字起こしデータ（非正規データ）
model InterviewTranscript {
  id            String    @id @default(cuid())
  jobSeekerId   String    @unique
  content       String    @db.Text
  interviewDate DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  jobSeeker JobSeeker @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)
}

// 応募先企業情報（志望動機生成用）
model TargetCompany {
  id                 String   @id @default(cuid())
  jobSeekerId        String   @unique
  companyUrl         String?  @db.VarChar(500)
  companyFeatures    String?  @db.Text
  generateMotivation Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  jobSeeker JobSeeker @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)
}

// 生成されたドキュメント情報
model GeneratedDocument {
  id           String   @id @default(cuid())
  jobSeekerId  String
  documentType String   // 'resume' or 'cv'
  googleDocId  String
  googleDocUrl String   @db.VarChar(500)
  version      Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  jobSeeker JobSeeker @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)

  @@index([jobSeekerId])
}

// 生成履歴
model GenerationLog {
  id              String   @id @default(cuid())
  jobSeekerId     String
  userId          String
  documentType    String?  // 'resume' or 'cv'
  documentUrl     String?  @db.VarChar(500)
  status          String   // 'success', 'failed', 'processing'
  errorMessage    String?  @db.Text
  llmModel        String?
  inputTokens     Int?
  outputTokens    Int?
  dataSourcesUsed Json?
  createdAt       DateTime @default(now())

  jobSeeker JobSeeker @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([jobSeekerId])
  @@index([userId])
}

// HubSpot項目マッピング設定
model HubspotMapping {
  id              String   @id @default(cuid())
  resumeField     String   @db.VarChar(50)
  hubspotProperty String   @db.VarChar(100)
  isActive        Boolean  @default(true)
  priority        Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 履歴書フォームデータ
model ResumeData {
  id             String    @id @default(cuid())
  jobSeekerId    String    @unique
  name           String?
  nameKana       String?
  gender         String?   @db.VarChar(10)
  birthDate      DateTime?
  postalCode     String?   @db.VarChar(10)
  address        String?   @db.Text
  addressKana    String?   @db.Text  // 住所ふりがな
  phone          String?   @db.VarChar(20)
  email          String?
  photoUrl       String?   @db.Text  // Base64画像データを保存
  education      Json?     // 学歴配列（履歴書用フォーマット）
  workHistory    Json?     // 職歴配列（履歴書用フォーマット）
  educationRaw   Json?     // 学歴フォーム生データ（再編集用）
  workHistoryRaw Json?     // 職歴フォーム生データ（再編集用）
  qualifications Json?     // 免許・資格配列
  preferences    String?   @db.Text // 本人希望欄
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  jobSeeker JobSeeker @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)
}

// 職務経歴書フォームデータ
model CvData {
  id             String    @id @default(cuid())
  jobSeekerId    String    @unique
  name           String?
  createdDate    DateTime?
  summary        String?   @db.Text  // 職務要約
  workHistory    Json?     // 職務経歴（会社ごと、リッチテキスト含む）
  skills         Json?     // 活かせる経験・スキル配列（後方互換性のため残す）
  skillsText     String?   @db.Text  // 活かせる経験・知識・技術（フリーテキスト、推奨）
  selfPrTitle    String?   @db.VarChar(200)
  selfPr         String?   @db.Text
  // 自由記述Ver用フィールド（DBマイグレーション後に有効化）
  // freeformSkills String?   @db.Text  // 活かせる経験・知識・技術（フリーテキスト）
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  jobSeeker JobSeeker @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)
}

// ========================================
// 日程調整機能用モデル
// ========================================

// 企業マスタ
model Company {
  id              String   @id @default(cuid())
  name            String
  // 基本情報
  headquarters    String?  // 本社住所
  industry        String?  // 業界
  employeeCount   String?  // 従業員数
  foundedDate     String?  // 設立年月
  website         String?  // 企業HP
  // 連絡先
  contactName     String?  // 担当者名
  contactEmail    String?  // 連絡先メール
  contactPhone    String?  // 連絡先電話
  // 詳細情報
  overview        String?  @db.Text  // 会社概要
  business        String?  @db.Text  // 事業概要
  // ステータス
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  jobs       Job[]             // この企業の求人一覧
  bookings   ScheduleBooking[]
  selections Selection[]       // この企業の選考一覧

  @@index([name])
  @@index([industry])
}

// 求人マスタ
model Job {
  id              String   @id @default(cuid())
  companyId       String
  // 基本情報
  title           String   // 求人タイトル
  jobCode         String?  // 求人コード（ATS連携用）
  category        String?  // 職種カテゴリ（事務・管理、営業、エンジニア等）
  // 募集概要
  salaryMin       Int?     // 年収下限（万円）
  salaryMax       Int?     // 年収上限（万円）
  salaryNote      String?  // 年収備考
  // 勤務地
  locations       Json?    // 勤務地リスト [{area: "東京都", detail: "渋谷区", note: "リモート可"}]
  remoteWork      String?  // リモート可否（full/partial/none）
  // 検索用タグ・特徴
  features        Json?    // 特徴タグ ["未経験OK", "学歴不問", "フルリモート", "フレックス", "土日祝休み"]
  searchKeywords  String?  @db.Text  // 検索用キーワード（全文検索用）
  // 仕事内容
  description     String?  @db.Text  // 仕事内容
  highlights      String?  @db.Text  // 仕事の醍醐味
  experience      String?  @db.Text  // 活躍できる経験
  // 必須・歓迎要件
  requirements    String?  @db.Text  // 必須要件
  preferences     String?  @db.Text  // 歓迎要件
  // 募集要項
  department      String?  @db.Text  // 部署詳細
  employmentType  String?  // 雇用形態（正社員、契約社員等）
  workHours       String?  // 勤務時間
  overtimeHours   String?  // 残業時間
  shortTime       String?  // 時短勤務
  selectionFlow   String?  @db.Text  // 選考フロー
  selectionDetail String?  @db.Text  // 選考詳細
  // 仕事環境
  probation       String?  // 試用期間
  probationDetail String?  @db.Text  // 試用期間詳細
  benefits        String?  @db.Text  // 給与・待遇詳細
  annualHolidays  Int?     // 年間休日
  holidays        String?  @db.Text  // 休日・休暇
  welfare         String?  @db.Text  // 福利厚生
  smoking         String?  // 受動喫煙対策
  smokingDetail   String?  // 受動喫煙対策詳細
  // ステータス
  status          JobStatus @default(active)
  publishedAt     DateTime?
  closedAt        DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  selections    Selection[]
  proposalItems ProposalItem[]

  @@index([companyId])
  @@index([status])
  @@index([category])
}

// 求人ステータス
enum JobStatus {
  draft      // 下書き
  active     // 公開中
  paused     // 一時停止
  closed     // 募集終了
}

// 面接形式
enum InterviewType {
  online
  onsite
  both    // 両方可能
}

// 日程ステータス
enum ScheduleStatus {
  available  // 空き（選択可能）
  booked     // 確定済み（企業が選択）
  blocked    // ブロック（対面面接の前後1時間）
  cancelled  // NG化・キャンセル済み
}

// 日程候補
model Schedule {
  id            String         @id @default(cuid())
  jobSeekerId   String
  date          DateTime       @db.Date
  startTime     String         @db.VarChar(5)  // "HH:MM" 形式
  endTime       String         @db.VarChar(5)  // "HH:MM" 形式
  interviewType InterviewType  @default(online)
  status        ScheduleStatus @default(available)
  blockedById   String?        // ブロック元の日程ID（blocked時のみ）
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  jobSeeker        JobSeeker         @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)
  booking          ScheduleBooking?
  blockedBy        Schedule?         @relation("BlockedSchedules", fields: [blockedById], references: [id])
  blockedSchedules Schedule[]        @relation("BlockedSchedules")

  @@index([jobSeekerId])
  @@index([status])
  @@index([date])
}

// 日程確定履歴
model ScheduleBooking {
  id            String         @id @default(cuid())
  scheduleId    String         @unique
  jobSeekerId   String
  companyId     String?
  companyName   String         // 企業名（手入力の場合も含む）
  // interviewType InterviewType  @default(online)  // 面接形式（オンライン/対面）- DBマイグレーション後に有効化
  confirmedAt   DateTime       @default(now())
  cancelledAt   DateTime?
  cancelReason  String?        @db.Text
  createdAt     DateTime       @default(now())

  schedule  Schedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  jobSeeker JobSeeker @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)
  company   Company?  @relation(fields: [companyId], references: [id])

  @@index([jobSeekerId])
  @@index([companyId])
  @@index([confirmedAt])
  @@index([cancelledAt])
}

// ========================================
// AI生成機能用モデル
// ========================================

// 生成テンプレート（推薦文・職務経歴書項目共通）
model GenerationTemplate {
  id          String   @id @default(cuid())
  type        String   @db.VarChar(20)  // "recommendation" | "summary" | "selfPr" | "skills" | "workHistory" | "cvFull"
  name        String   // パターン名（例：営業職向け）
  prompt      String   @db.Text  // プロンプト本文
  exampleText String?  @db.Text  // 例文（任意）
  isDefault   Boolean  @default(false)  // デフォルトテンプレートフラグ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([name])
}

// デフォルト情報ソース設定（全社共通）
model GenerationSourceDefault {
  id        String   @id @default(cuid())
  type      String   @unique @db.VarChar(20)  // "recommendation" | "summary" | "selfPr" | "skills" | "workHistory" | "cvFull"
  sources   Json     // [{ source: "resume", priority: 1 }, { source: "transcript", priority: 2 }, { source: "questionnaire", priority: 3 }]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 推薦文テンプレート（職種パターン）- 後方互換性のため残す
model RecommendationTemplate {
  id          String   @id @default(cuid())
  name        String   // 職種名（例：エンジニア職）
  points      String   @db.Text  // 推薦文作成時のポイント
  exampleText String?  @db.Text  // 推薦文の例文（任意）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  recommendations RecommendationLetter[]

  @@index([name])
}

// 推薦文
model RecommendationLetter {
  id                   String   @id @default(cuid())
  jobSeekerId          String   @unique  // 求職者ごとに1件のみ
  templateId           String?  // 旧テンプレート（後方互換性）
  generationTemplateId String?  // 新テンプレート（GenerationTemplate）
  content              String   @db.Text  // 推薦文本文
  editHistory          Json?    // 編集履歴（チャット形式）
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  jobSeeker JobSeeker               @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)
  template  RecommendationTemplate? @relation(fields: [templateId], references: [id])

  @@index([jobSeekerId])
  @@index([templateId])
}

// ========================================
// 選考管理機能用モデル
// ========================================

// 選考ステータス
enum SelectionStatus {
  // 応募前
  proposal              // 提案中（候補リスト）
  not_applying          // 応募しない
  
  // 書類選考
  entry_preparing       // エントリー準備中
  entry_requested       // エントリー依頼済み（RA事務へ）
  entry_completed       // エントリー完了
  document_submitted    // 書類提出済み
  document_screening    // 書類選考中
  document_passed       // 書類通過
  document_rejected     // 書類不通過
  
  // 日程調整
  scheduling            // 日程調整中
  schedule_confirmed    // 日程確定
  
  // 面接
  first_interview       // 一次面接予定
  first_interview_done  // 一次面接完了
  second_interview      // 二次面接予定
  second_interview_done // 二次面接完了
  final_interview       // 最終面接予定
  final_interview_done  // 最終面接完了
  
  // 内定
  offer                 // 内定
  offer_accepted        // 内定承諾
  offer_rejected        // 内定辞退
  
  // 終了
  withdrawn             // 辞退（求職者）
  rejected              // 不採用（企業）
  cancelled             // キャンセル
}

// 選考
model Selection {
  id              String          @id @default(cuid())
  jobSeekerId     String
  jobSeekerName   String          // 求職者名（表示用）
  companyId       String?         // 企業マスタID（任意）
  companyName     String          // 企業名
  companyEmail    String?         // 企業連絡先メール
  jobId           String?         // 求人マスタID（任意）
  jobTitle        String?         // 求人タイトル
  status          SelectionStatus @default(proposal)
  
  // 担当CA
  assignedCAId    String          // 担当CAのUser ID
  assignedCAName  String          // 担当CA名（表示用）
  
  // 選考IDタグ（メール紐づけ用）
  selectionTag    String          @unique @default(cuid())
  
  // 日程調整URL
  scheduleUrl     String?
  
  // 辞退・不採用理由
  withdrawReason  String?         @db.VarChar(50)   // 辞退理由カテゴリ
  withdrawComment String?         @db.Text          // 辞退理由詳細
  rejectReason    String?         @db.VarChar(50)   // 不採用理由カテゴリ
  rejectComment   String?         @db.Text          // 不採用理由詳細
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  jobSeeker         JobSeeker       @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)
  company           Company?        @relation(fields: [companyId], references: [id])
  job               Job?            @relation(fields: [jobId], references: [id])
  assignedCA        User            @relation(fields: [assignedCAId], references: [id])
  messages          Message[]
  statusHistory     SelectionStatusHistory[]
  interviewDetails  InterviewDetail[]  // 面接詳細（複数回対応）

  @@index([jobSeekerId])
  @@index([companyId])
  @@index([assignedCAId])
  @@index([status])
  @@index([selectionTag])
}

// 選考ステータス変更履歴
model SelectionStatusHistory {
  id          String          @id @default(cuid())
  selectionId String
  fromStatus  SelectionStatus?
  toStatus    SelectionStatus
  changedById String?         // 変更者のUser ID
  changedBy   String?         // 変更者名
  note        String?         @db.Text  // 変更理由・メモ
  createdAt   DateTime        @default(now())

  selection   Selection       @relation(fields: [selectionId], references: [id], onDelete: Cascade)

  @@index([selectionId])
  @@index([createdAt])
}

// 面接形式（面接詳細用）
enum InterviewFormat {
  online    // オンライン
  onsite    // 対面
}

// 面接詳細
model InterviewDetail {
  id              String          @id @default(cuid())
  selectionId     String
  interviewRound  Int             @default(1)  // 面接回数（1: 一次, 2: 二次, 3: 最終）
  
  // 日程（日程調整から自動入力可能）
  scheduledAt     DateTime?       // 面接日時
  duration        Int?            // 面接時間（分）
  
  // 形式
  format          InterviewFormat @default(online)
  location        String?         // 対面の場合の場所
  onlineUrl       String?         // オンラインの場合のURL（Zoom等）
  
  // 詳細情報
  interviewers    String?         // 面接官（名前・役職）
  preparation     String?         @db.Text  // 準備事項
  dressCode       String?         // 服装
  notes           String?         @db.Text  // 注意事項・備考
  
  // リマインダー設定
  reminderSent    Boolean         @default(false)  // リマインダー送信済みフラグ
  reminderAt      DateTime?       // リマインダー送信日時
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  selection       Selection       @relation(fields: [selectionId], references: [id], onDelete: Cascade)

  @@index([selectionId])
  @@index([scheduledAt])
}

// ========================================
// メッセージ機能用モデル
// ========================================

// メッセージ方向
enum MessageDirection {
  inbound   // 受信（企業→RA）
  outbound  // 送信（CA→企業）
}

// メッセージステータス
enum MessageStatus {
  received      // 受信済み
  draft         // 下書き
  pending_send  // 送信待ち（RA事務へ依頼中）
  sent          // 送信済み
  failed        // 送信失敗
}

// 送信方法
enum SendMethod {
  gmail   // Gmail経由
  ats     // ATS経由
}

// メッセージ
model Message {
  id            String           @id @default(cuid())
  selectionId   String
  
  // 方向
  direction     MessageDirection
  
  // 受信の場合
  fromEmail     String?          // 送信元メールアドレス
  fromName      String?          // 送信者名
  gmailMessageId String?         // Gmail Message ID（重複防止用）
  gmailThreadId  String?         // Gmail Thread ID
  
  // 送信の場合
  createdByCAId   String?        // 作成したCAのUser ID
  createdByCAName String?        // 作成したCA名
  
  // 内容
  subject       String
  body          String           @db.Text
  attachments   Json?            // 添付ファイル情報
  
  // ステータス
  status        MessageStatus    @default(received)
  
  // 送信情報
  sendMethod    SendMethod?      // 送信方法（gmail or ats）
  sentByRAId    String?          // 送信したRA事務のUser ID
  sentByRAName  String?          // 送信したRA事務名
  sentAt        DateTime?        // 送信日時
  
  // 日時
  receivedAt    DateTime?        // 受信日時（受信メールの場合）
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  selection     Selection        @relation(fields: [selectionId], references: [id], onDelete: Cascade)

  @@index([selectionId])
  @@index([status])
  @@index([gmailMessageId])
  @@index([gmailThreadId])
  @@index([createdAt])
}

// ========================================
// CA権限管理用モデル
// ========================================

// CAロール
enum CARole {
  admin     // 管理者
  manager   // マネージャー
  member    // メンバー
  ra_admin  // RA事務
}

// CAチーム情報（Userモデルを拡張）
model CAProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  role        CARole   @default(member)
  teamId      String?  // チームID
  teamName    String?  // チーム名
  managerId   String?  // マネージャーのUser ID
  
  // HubSpot連携
  hubspotOwnerId    String?  // HubSpotオーナーID
  hubspotOwnerEmail String?  // HubSpotオーナーメール
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([role])
}

// ========================================
// 求人提案機能用モデル
// ========================================

// 提案表
model Proposal {
  id            String   @id @default(cuid())
  jobSeekerId   String
  createdById   String   // 作成したCAのUser ID
  createdByName String   // 作成したCA名
  title         String?  // 提案表タイトル
  note          String?  @db.Text  // CAからのコメント
  status        ProposalStatus @default(draft)
  sentAt        DateTime?  // 送信日時
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  jobSeeker JobSeeker      @relation(fields: [jobSeekerId], references: [id], onDelete: Cascade)
  items     ProposalItem[]

  @@index([jobSeekerId])
  @@index([createdById])
  @@index([status])
}

// 提案表アイテム（提案する求人）
model ProposalItem {
  id          String   @id @default(cuid())
  proposalId  String
  jobId       String
  order       Int      @default(0)  // 表示順
  recommend   String?  @db.Text     // おすすめポイント
  createdAt   DateTime @default(now())

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  job      Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([proposalId])
  @@index([jobId])
}

// 提案表ステータス
enum ProposalStatus {
  draft   // 下書き
  sent    // 送信済み
}
